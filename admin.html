<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CANDY BOSS - å¾Œå°ç®¡ç†</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #FFD700;
            --purple: #C084FC;
            --purple-dim: rgba(192,132,252,0.15);
            --green: #00FF00;
            --red: #ff4444;
            --bg: #0a0a0a;
            --card: rgba(255,255,255,0.04);
            --border: rgba(255,255,255,0.08);
        }
        html, body { background: var(--bg); color: #fff; font-family: 'Noto Sans TC', sans-serif; min-height: 100vh; }

        /* â”€â”€ ç™»å…¥ç•«é¢ â”€â”€ */
        #loginScreen {
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; padding: 20px;
        }
        .login-box {
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--purple);
            border-radius: 24px; padding: 48px 36px;
            text-align: center; max-width: 360px; width: 100%;
        }
        .login-box .icon { font-size: 56px; margin-bottom: 16px; }
        .login-box h1 { font-family: 'Orbitron', sans-serif; font-size: 22px; color: var(--purple); margin-bottom: 8px; }
        .login-box p { color: #999; font-size: 14px; margin-bottom: 32px; line-height: 1.6; }
        .line-btn {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            background: #06C755; color: #fff; border: none;
            padding: 14px 28px; border-radius: 30px; font-size: 16px;
            font-weight: 700; cursor: pointer; width: 100%;
            transition: all 0.2s;
        }
        .line-btn:hover { background: #05a847; transform: scale(1.03); }

        /* â”€â”€ é ‚éƒ¨å°è¦½ â”€â”€ */
        .navbar {
            position: sticky; top: 0; z-index: 100;
            background: rgba(10,10,10,0.96); backdrop-filter: blur(12px);
            border-bottom: 2px solid var(--purple);
            padding: 14px 20px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .navbar-left { display: flex; align-items: center; gap: 12px; }
        .logo { font-family: 'Orbitron', sans-serif; font-size: 18px; font-weight: 900; color: var(--purple); }
        .admin-badge {
            background: var(--purple-dim); border: 1px solid var(--purple);
            color: var(--purple); font-size: 11px; font-weight: 700;
            padding: 3px 10px; border-radius: 20px;
        }
        .admin-info { display: flex; align-items: center; gap: 10px; }
        .admin-info img { width: 34px; height: 34px; border-radius: 50%; border: 2px solid var(--purple); }
        .admin-name { font-size: 13px; color: #ccc; }
        .logout-btn {
            background: rgba(255,68,68,0.1); border: 1px solid var(--red);
            color: var(--red); padding: 6px 14px; border-radius: 16px;
            font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s;
        }
        .logout-btn:hover { background: var(--red); color: #fff; }

        /* â”€â”€ Tab å°è¦½ â”€â”€ */
        .tab-bar {
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid var(--border);
            display: flex; overflow-x: auto;
            scrollbar-width: none; padding: 0 16px;
        }
        .tab-bar::-webkit-scrollbar { display: none; }
        .tab {
            display: flex; align-items: center; gap: 6px;
            padding: 14px 20px; font-size: 14px; font-weight: 700;
            color: #666; cursor: pointer; white-space: nowrap;
            border-bottom: 3px solid transparent;
            transition: all 0.2s; flex-shrink: 0;
        }
        .tab:hover { color: #ccc; }
        .tab.active { color: var(--purple); border-bottom-color: var(--purple); }

        /* â”€â”€ ä¸»å…§å®¹ â”€â”€ */
        #mainApp { display: none; }
        .page { display: none; max-width: 960px; margin: 0 auto; padding: 24px 20px; }
        #page-stock { max-width: 100%; }
        .page.active { display: block; }

        /* â”€â”€ å¡ç‰‡ â”€â”€ */
        .card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 16px; padding: 20px; margin-bottom: 14px;
            transition: border-color 0.2s;
        }
        .card:hover { border-color: rgba(192,132,252,0.3); }

        /* â”€â”€ é é¢æ¨™é¡Œåˆ— â”€â”€ */
        .page-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 20px; flex-wrap: wrap; gap: 12px;
        }
        .page-title { font-size: 20px; font-weight: 900; color: var(--purple); }
        .page-subtitle { font-size: 13px; color: #666; margin-top: 2px; }

        /* â”€â”€ æŒ‰éˆ• â”€â”€ */
        .btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 9px 18px; border-radius: 20px; font-size: 13px;
            font-weight: 700; cursor: pointer; border: none; transition: all 0.2s;
        }
        .btn-purple { background: var(--purple-dim); border: 1.5px solid var(--purple); color: var(--purple); }
        .btn-purple:hover { background: var(--purple); color: #fff; }
        .btn-green { background: rgba(0,255,0,0.1); border: 1.5px solid var(--green); color: var(--green); }
        .btn-green:hover { background: var(--green); color: #000; }
        .btn-red { background: rgba(255,68,68,0.1); border: 1.5px solid var(--red); color: var(--red); }
        .btn-red:hover { background: var(--red); color: #fff; }
        .btn-yellow { background: rgba(255,215,0,0.1); border: 1.5px solid var(--primary); color: var(--primary); }
        .btn-yellow:hover { background: var(--primary); color: #000; }
        .btn-sm { padding: 5px 12px; font-size: 12px; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; }

        /* â”€â”€ ç‹€æ…‹å¾½ç«  â”€â”€ */
        .badge {
            display: inline-block; padding: 3px 10px; border-radius: 20px;
            font-size: 11px; font-weight: 700;
        }
        .badge-green { background: rgba(0,255,0,0.15); color: var(--green); border: 1px solid rgba(0,255,0,0.3); }
        .badge-red { background: rgba(255,68,68,0.15); color: var(--red); border: 1px solid rgba(255,68,68,0.3); }
        .badge-yellow { background: rgba(255,215,0,0.15); color: var(--primary); border: 1px solid rgba(255,215,0,0.3); }
        .badge-gray { background: rgba(255,255,255,0.08); color: #999; border: 1px solid rgba(255,255,255,0.1); }
        .badge-purple { background: var(--purple-dim); color: var(--purple); border: 1px solid rgba(192,132,252,0.3); }

        /* â”€â”€ è¡¨å–®å…ƒç´  â”€â”€ */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; color: #999; margin-bottom: 6px; font-weight: 500; }
        .form-input, .form-select, .form-textarea {
            width: 100%; background: #111; border: 1.5px solid rgba(255,255,255,0.1);
            border-radius: 10px; padding: 10px 14px; color: #fff; font-size: 14px;
            outline: none; transition: border-color 0.2s; font-family: inherit;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--purple); }
        .form-textarea { resize: vertical; min-height: 80px; }
        .form-select option { background: #1a1a1a; }

        /* â”€â”€ Modal â”€â”€ */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.85); z-index: 9000;
            overflow-y: auto; padding: 20px;
        }
        .modal-overlay.active { display: flex; align-items: flex-start; justify-content: center; }
        .modal-box {
            background: #141414; border: 2px solid var(--purple);
            border-radius: 20px; width: 100%; max-width: 540px;
            margin: 40px auto; overflow: hidden;
        }
        .modal-header {
            background: var(--purple-dim); padding: 16px 20px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid rgba(192,132,252,0.2);
        }
        .modal-title { font-size: 16px; font-weight: 900; color: var(--purple); }
        .modal-close {
            background: none; border: none; color: #999;
            font-size: 22px; cursor: pointer; line-height: 1;
            transition: color 0.2s;
        }
        .modal-close:hover { color: #fff; }
        .modal-body { padding: 22px; }
        .modal-footer { padding: 16px 22px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }

        /* â”€â”€ Toast â”€â”€ */
        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #222; color: #fff; padding: 12px 24px;
            border-radius: 30px; font-size: 14px; font-weight: 700;
            z-index: 99999; opacity: 0; transition: opacity 0.3s;
            border: 1px solid rgba(255,255,255,0.1); white-space: nowrap;
            pointer-events: none;
        }
        #toast.show { opacity: 1; }
        #toast.success { border-color: var(--green); color: var(--green); }
        #toast.error { border-color: var(--red); color: var(--red); }

        /* â”€â”€ è¼‰å…¥ä¸­ â”€â”€ */
        .loading-state {
            text-align: center; padding: 60px 20px; color: #555;
        }
        .loading-state .icon { font-size: 40px; margin-bottom: 16px; }

        /* â”€â”€ å„ªæƒ å¡ç‰‡ â”€â”€ */
        .promo-card {
            display: flex; align-items: flex-start; justify-content: space-between;
            gap: 14px; flex-wrap: wrap;
        }
        .promo-info { flex: 1; min-width: 0; }
        .promo-name { font-size: 16px; font-weight: 900; color: #fff; margin-bottom: 6px; }
        .promo-meta { font-size: 12px; color: #888; line-height: 1.7; }
        .promo-actions { display: flex; gap: 8px; flex-shrink: 0; align-items: center; }

        /* â”€â”€ å…¬å‘Šå¡ç‰‡ â”€â”€ */
        .ann-card { display: flex; align-items: flex-start; justify-content: space-between; gap: 14px; flex-wrap: wrap; }
        .ann-text { font-size: 15px; font-weight: 700; color: #fff; margin-bottom: 6px; flex: 1; }
        .ann-link { font-size: 12px; color: #888; word-break: break-all; }

        /* â”€â”€ è¨‚å–®å¡ç‰‡ â”€â”€ */
        .order-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 12px; align-items: center;
        }
        .order-name { font-weight: 700; font-size: 15px; }
        .order-meta { font-size: 12px; color: #888; line-height: 1.6; }
        .order-amount { font-size: 18px; font-weight: 900; color: var(--primary); white-space: nowrap; }

        /* â”€â”€ æœƒå“¡å¡ç‰‡ â”€â”€ */
        .member-row { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }
        .member-avatar { width: 46px; height: 46px; border-radius: 50%; border: 2px solid rgba(255,215,0,0.3); flex-shrink: 0; }
        .member-info { flex: 1; min-width: 0; }
        .member-name { font-weight: 700; font-size: 15px; }
        .member-sub { font-size: 12px; color: #888; margin-top: 3px; }
        .member-actions { display: flex; gap: 8px; flex-shrink: 0; }

        /* â”€â”€ æœå°‹æ¬„ â”€â”€ */
        .search-bar {
            display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap;
        }
        .search-input {
            flex: 1; min-width: 200px;
            background: #111; border: 1.5px solid var(--border);
            border-radius: 10px; padding: 9px 14px; color: #fff; font-size: 14px;
            outline: none; font-family: inherit;
        }
        .search-input:focus { border-color: var(--purple); }

        /* â”€â”€ çµ±è¨ˆå¡ç‰‡ â”€â”€ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 14px; margin-bottom: 24px; }
        .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 18px; text-align: center; }
        .stat-num { font-size: 28px; font-weight: 900; color: var(--purple); }
        .stat-label { font-size: 12px; color: #666; margin-top: 4px; }

        /* â”€â”€ åˆ†é  â”€â”€ */
        .pagination { display: flex; gap: 8px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .page-btn { background: var(--card); border: 1px solid var(--border); color: #999; padding: 7px 14px; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 700; transition: all 0.2s; }
        .page-btn:hover { border-color: var(--purple); color: var(--purple); }
        .page-btn.active { background: var(--purple-dim); border-color: var(--purple); color: var(--purple); }

        /* â”€â”€ åº«å­˜å¡ç‰‡ â”€â”€ */
        .stock-product { margin-bottom: 12px; }
        .stock-product-name { font-size: 15px; font-weight: 900; margin-bottom: 4px; }
        .stock-product-id { font-size: 11px; color: #666; margin-bottom: 10px; }
        .stock-specs-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .spec-chip {
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px; padding: 10px 14px;
            display: flex; align-items: center; gap: 10px; flex: 1; min-width: 130px;
        }
        .spec-chip-name { font-size: 12px; color: #888; }
        .spec-chip-stock { font-size: 22px; font-weight: 900; }
        .spec-chip-stock.ok   { color: #00FF00; }
        .spec-chip-stock.low  { color: #ffa500; }
        .spec-chip-stock.zero { color: #ff4444; }

        /* â”€â”€ ç‹€æ…‹ Pill â”€â”€ */
        .ship-tab {
            padding: 7px 18px; border-radius: 9px; font-size: 13px; font-weight: 700;
            cursor: pointer; border: none; background: transparent; color: #666;
            transition: all .2s; white-space: nowrap;
        }
        .ship-tab:hover { color: #fff; }
        .ship-tab.active { background: rgba(255,215,0,0.18); color: #FFD700; }

        .order-pill {
            padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 700;
            cursor: pointer; border: 1.5px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.04); color: #888; transition: all .2s;
            white-space: nowrap;
        }
        .order-pill:hover { border-color: rgba(255,215,0,0.4); color: #FFD700; }
        .order-pill.active { background: rgba(255,215,0,0.15); border-color: #FFD700; color: #FFD700; }

        /* â”€â”€ è¨‚å–®å¡ç‰‡å¿«é€Ÿæ“ä½œåˆ— â”€â”€ */
        .order-quick-actions {
            display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap;
            padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.06);
        }
        .quick-btn {
            padding: 4px 10px; border-radius: 14px; font-size: 11px; font-weight: 700;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05); color: #888; transition: all .15s;
        }
        .quick-btn:hover { opacity: 0.85; }
        .quick-btn.q-ship  { border-color: #a78bfa; color: #a78bfa; background: rgba(167,139,250,0.1); }
        .quick-btn.q-done  { border-color: #00FF00; color: #00FF00; background: rgba(0,255,0,0.1); }
        .quick-btn.q-cancel{ border-color: #ff4444; color: #ff4444; background: rgba(255,68,68,0.1); }
        .quick-btn.q-detail{ border-color: #FFD700; color: #FFD700; background: rgba(255,215,0,0.1); }

        /* â”€â”€ å–è²¨æ–¹å¼ badge â”€â”€ */
        .ship-711  { background: rgba(255,165,0,0.15); color: #ffa500; border: 1px solid rgba(255,165,0,0.3); }
        .ship-self { background: rgba(96,165,250,0.15); color: #60a5fa; border: 1px solid rgba(96,165,250,0.3); }

        @media (max-width: 600px) {
            .order-row { grid-template-columns: 1fr; }
            .promo-actions { width: 100%; justify-content: flex-end; }
        }
        @keyframes pulse {
            0%,100% { opacity:1; }
            50%      { opacity:0.4; }
        }

        /* â”€â”€ åº«å­˜æ©«å¼è¡¨æ ¼ â”€â”€ */
        .stock-table-wrap {
            overflow-x: auto;
            border-radius: 14px;
            border: 1px solid var(--border);
        }
        .stock-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            min-width: 1100px;
        }
        .stock-table th {
            background: rgba(192,132,252,0.1);
            color: var(--purple);
            font-weight: 900;
            padding: 8px 8px;
            text-align: left;
            border-bottom: 2px solid rgba(192,132,252,0.2);
            white-space: nowrap;
            font-size: 11px;
        }
        .stock-table td {
            padding: 6px 7px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            vertical-align: middle;
        }
        .stock-table tr:last-child td { border-bottom: none; }
        .stock-table tr:hover td { background: rgba(255,255,255,0.03); }
        .stock-table tr.editing td { background: rgba(192,132,252,0.06); }
        .stock-td-img { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; border: 1px solid rgba(255,255,255,0.1); }
        .stock-td-img-empty { width: 40px; height: 40px; border-radius: 6px; background: rgba(255,255,255,0.05); display:flex; align-items:center; justify-content:center; color:#555; font-size:18px; }
        .stock-num { font-weight: 900; font-size: 15px; }
        .stock-num.ok   { color: #00FF00; }
        .stock-num.low  { color: #ffa500; }
        .stock-num.zero { color: #ff4444; }
        .stock-price { font-size: 12px; color: #888; }
        .stock-sale  { font-size: 12px; color: var(--primary); }
        .stock-sync  { font-size: 11px; color: #555; }
        .tbl-input {
            background: #111; border: 1.5px solid var(--purple);
            border-radius: 8px; padding: 4px 7px; color: #fff;
            font-size: 12px; width: 70px; outline: none;
        }
        .tbl-input-wide { width: 110px; }
        .tbl-actions { display: flex; gap: 6px; white-space: nowrap; }
    </style>
</head>
<body>

<!-- ========== ç™»å…¥ç•«é¢ ========== -->
<div id="loginScreen">
    <div class="login-box">
        <div class="icon">âš™ï¸</div>
        <h1>CANDY BOSS</h1>
        <p>å¾Œå°ç®¡ç†ç³»çµ±<br>åƒ…é™æˆæ¬Šç®¡ç†å“¡ç™»å…¥</p>
        <button class="line-btn" onclick="lineLogin()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M12 .5C5.649.5.5 4.906.5 10.281c0 4.757 3.752 8.747 9.027 9.636.352.076.83.233.95.534.109.272.071.698.035 1.007l-.154.924c-.047.272-.218 1.063.931.58 1.15-.484 6.205-3.657 8.47-6.259C21.44 14.94 23.5 12.714 23.5 10.281 23.5 4.906 18.351.5 12 .5z"/></svg>
            LINE ç™»å…¥
        </button>
    </div>
</div>

<!-- ========== ä¸»æ‡‰ç”¨ ========== -->
<div id="mainApp">
    <!-- é ‚éƒ¨å°è¦½ -->
    <nav class="navbar">
        <div class="navbar-left">
            <div class="logo">REX</div>
            <div class="admin-badge">å¾Œå°ç®¡ç†</div>
        </div>
        <div class="admin-info">
            <img id="adminAvatar" src="" alt="">
            <span class="admin-name" id="adminName"></span>
            <button id="speedTestBtn" onclick="testInitSpeed()"
                style="padding:6px 14px;border-radius:20px;border:1.5px solid #ffa500;background:rgba(255,165,0,0.08);color:#ffa500;font-size:12px;font-weight:900;cursor:pointer;transition:all .2s;">
                ğŸï¸ æ¸¬é€Ÿ
            </button>
            <button id="cacheRefreshBtn" onclick="refreshCache()"
                style="padding:6px 14px;border-radius:20px;border:1.5px solid #00bfff;background:rgba(0,191,255,0.08);color:#00bfff;font-size:12px;font-weight:900;cursor:pointer;transition:all .2s;">
                âš¡ åˆ·æ–°å¿«å–
            </button>
            <button id="maintenanceBtn" onclick="toggleMaintenance()"
                style="padding:6px 14px;border-radius:20px;border:1.5px solid #555;background:rgba(255,255,255,0.05);color:#888;font-size:12px;font-weight:900;cursor:pointer;transition:all .2s;">
                ğŸ”§ ç¶­è­·æ¨¡å¼
            </button>
            <button id="monitorBtn" onclick="toggleMonitor()"
                style="padding:6px 14px;border-radius:20px;border:1.5px solid #555;background:rgba(255,255,255,0.05);color:#888;font-size:12px;font-weight:900;cursor:pointer;transition:all .2s;">
                ğŸ‘ï¸ ç›£æ§æ¨¡å¼
            </button>
            <button class="logout-btn" onclick="adminLogout()">ç™»å‡º</button>
        </div>
    </nav>

    <!-- Tab å°è¦½ -->
    <div class="tab-bar">
        <div class="tab active" onclick="switchTab('orders')" id="tab-orders">ğŸ“‹ è¨‚å–®ç®¡ç†</div>
        <div class="tab" onclick="switchTab('stock')" id="tab-stock">ğŸ“¦ åº«å­˜ç®¡ç†</div>
        <div class="tab" onclick="switchTab('announcements')" id="tab-announcements">ğŸ“¢ å…¬å‘Šç®¡ç†</div>
        <div class="tab" onclick="switchTab('promos')" id="tab-promos">ğŸ å„ªæƒ è¨­å®š</div>
        <div class="tab" onclick="switchTab('members')" id="tab-members">ğŸ‘¥ æœƒå“¡ç®¡ç†</div>
    </div>

    <!-- ========== å„ªæƒ è¨­å®š ========== -->
    <div class="page" id="page-promos">
        <div class="page-header">
            <div>
                <div class="page-title">ğŸ å„ªæƒ è¨­å®š</div>
                <div class="page-subtitle">ç®¡ç†è³¼ç‰©å„ªæƒ è¦å‰‡ï¼Œç›´æ¥åŒæ­¥è‡³ Google Sheet</div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-green" onclick="loadPromos()">ğŸ”„ é‡æ–°æ•´ç†</button>
                <button class="btn btn-purple" onclick="openPromoModal()">ï¼‹ æ–°å¢å„ªæƒ </button>
            </div>
        </div>
        <div id="promoList">
            <div class="loading-state"><div class="icon">â³</div><div>è¼‰å…¥ä¸­...</div></div>
        </div>
    </div>

    <!-- ========== å…¬å‘Šç®¡ç† ========== -->
    <div class="page" id="page-announcements">
        <div class="page-header">
            <div>
                <div class="page-title">ğŸ“¢ å…¬å‘Šç®¡ç†</div>
                <div class="page-subtitle">ç®¡ç†è·‘é¦¬ç‡ˆå…¬å‘Šï¼Œå•Ÿç”¨ä¸­çš„å…¬å‘Šæœƒé¡¯ç¤ºåœ¨å‰å°</div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-green" onclick="loadAnnouncements()">ğŸ”„ é‡æ–°æ•´ç†</button>
                <button class="btn btn-purple" onclick="openAnnModal()">ï¼‹ æ–°å¢å…¬å‘Š</button>
            </div>
        </div>
        <div id="annList">
            <div class="loading-state"><div class="icon">â³</div><div>è¼‰å…¥ä¸­...</div></div>
        </div>
    </div>

    <!-- ========== æœƒå“¡ç®¡ç† ========== -->
    <div class="page" id="page-members">
        <div class="page-header">
            <div>
                <div class="page-title">ğŸ‘¥ æœƒå“¡ç®¡ç†</div>
                <div class="page-subtitle">å¯©æ ¸æœƒå“¡ç”³è«‹ï¼Œç®¡ç†æœƒå“¡ç‹€æ…‹</div>
            </div>
            <button class="btn btn-green" onclick="loadMembers()">ğŸ”„ é‡æ–°æ•´ç†</button>
        </div>
        <div class="search-bar">
            <input class="search-input" id="memberSearch" placeholder="ğŸ” æœå°‹å§“åã€é›»è©±ã€LINE ID..." oninput="filterMembers()">
            <select class="form-select" id="memberStatusFilter" onchange="filterMembers()" style="width:auto; padding:9px 14px;">
                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                <option value="å¾…å¯©æ ¸">å¾…å¯©æ ¸</option>
                <option value="å·²é€šé">å·²é€šé</option>
                <option value="å·²æ‹’çµ•">å·²æ‹’çµ•</option>
            </select>
        </div>
        <div id="memberList">
            <div class="loading-state"><div class="icon">â³</div><div>è¼‰å…¥ä¸­...</div></div>
        </div>
    </div>


    <!-- ========== åº«å­˜ç®¡ç† ========== -->
    <div class="page" id="page-stock">
        <div class="page-header">
            <div>
                <div class="page-title">ğŸ“¦ åº«å­˜ç®¡ç†</div>
                <div class="page-subtitle">æŸ¥çœ‹ã€ä¿®æ”¹å•†å“åº«å­˜ï¼Œæˆ–æ–°å¢å•†å“</div>
            </div>
            <div style="display:flex;gap:8px;">
                <button class="btn btn-green" onclick="reloadCurrentTab()">ğŸ”„ é‡æ–°æ•´ç†</button>
                <button class="btn btn-purple" onclick="openAddProductModal()">ï¼‹ æ–°å¢å•†å“</button>
            </div>
        </div>
        <div class="search-bar">
            <input class="search-input" id="stockSearch" placeholder="ğŸ” æœå°‹å•†å“ç·¨è™Ÿ/åç¨±/é¡åˆ¥..." oninput="filterStock()">
            <select class="form-select" id="stockCatFilter" onchange="filterStock()" style="width:160px;flex-shrink:0;">
                <option value="">å…¨éƒ¨é¡åˆ¥</option>
            </select>
        </div>
        <div id="stockList">
            <div class="loading-state"><div class="icon">â³</div><div>è¼‰å…¥ä¸­...</div></div>
        </div>
    </div>

    <!-- ========== æ‰€æœ‰è¨‚å–® ========== -->
    <div class="page active" id="page-orders">
        <div class="page-header">
            <div>
                <div class="page-title">ğŸ“‹ æ‰€æœ‰è¨‚å–®</div>
                <div class="page-subtitle">æŸ¥çœ‹æ‰€æœ‰æœƒå“¡çš„è¨‚å–®è¨˜éŒ„</div>
            </div>
            <button class="btn btn-green" onclick="loadOrders(true)">ğŸ”„ é‡æ–°æ•´ç†</button>
        </div>
        <div class="stats-grid" id="orderStats"></div>
        <!-- å–è²¨æ–¹å¼ Tab -->
        <div style="display:flex; gap:0; margin-bottom:14px; background:rgba(255,255,255,0.04); border-radius:12px; padding:4px; width:fit-content;">
            <button class="ship-tab active" data-ship="" onclick="setShipTab(this,'')">å…¨éƒ¨</button>
            <button class="ship-tab" data-ship="711" onclick="setShipTab(this,'711')">ğŸª 7-11</button>
            <button class="ship-tab" data-ship="self" onclick="setShipTab(this,'self')">ğŸš¶ è‡ªå–</button>
        </div>
        <div class="search-bar">
            <input class="search-input" id="orderSearch" placeholder="ğŸ” æœå°‹å§“åã€é›»è©±ã€è¨‚å–®ç·¨è™Ÿ..." oninput="filterOrders()">
            <select class="form-select" id="orderStatusFilter" onchange="filterOrders()" style="width:160px;flex-shrink:0;">
                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                <option value="å¾…ç¢ºèª">å¾…ç¢ºèª</option>
                <option value="å·²ä»˜æ¬¾å¾…å‡ºè²¨">å·²ä»˜æ¬¾å¾…å‡ºè²¨</option>
                <option value="å‡ºè²¨ä¸­">å‡ºè²¨ä¸­</option>
                <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                <option value="å–æ¶ˆè¨‚å–®">å–æ¶ˆè¨‚å–®</option>
            </select>
        </div>
        <!-- ç‹€æ…‹ Pill ç¯©é¸å™¨ -->
        <div id="orderStatusPills" style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:14px;">
            <button class="order-pill active" data-status="" onclick="setOrderStatus('')">å…¨éƒ¨</button>
            <button class="order-pill" data-status="å¾…ç¢ºèª" onclick="setOrderStatus('å¾…ç¢ºèª')">â³ å¾…ç¢ºèª</button>
            <button class="order-pill" data-status="å·²ä»˜æ¬¾å¾…å‡ºè²¨" onclick="setOrderStatus('å·²ä»˜æ¬¾å¾…å‡ºè²¨')">ğŸ’° å¾…å‡ºè²¨</button>
            <button class="order-pill" data-status="å‡ºè²¨ä¸­" onclick="setOrderStatus('å‡ºè²¨ä¸­')">ğŸšš å‡ºè²¨</button>
            <button class="order-pill" data-status="å·²å®Œæˆ" onclick="setOrderStatus('å·²å®Œæˆ')">âœ… å·²å®Œæˆ</button>
            <button class="order-pill" data-status="å–æ¶ˆè¨‚å–®" onclick="setOrderStatus('å–æ¶ˆè¨‚å–®')">âŒ å–æ¶ˆ</button>
        </div>
        <div id="orderList">
            <div class="loading-state"><div class="icon">â³</div><div>è¼‰å…¥ä¸­...</div></div>
        </div>
    </div>
</div>

<!-- ========== å„ªæƒ  Modal ========== -->
<div class="modal-overlay" id="promoModal">
    <div class="modal-box">
        <div class="modal-header">
            <div class="modal-title" id="promoModalTitle">æ–°å¢å„ªæƒ </div>
            <button class="modal-close" onclick="closePromoModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="pf_rowIndex">
            <div class="form-group">
                <label class="form-label">å„ªæƒ åç¨± *</label>
                <input class="form-input" id="pf_name" type="text" placeholder="ä¾‹ï¼šè²·5æ¢æŠ˜20">
            </div>
            <div class="form-group">
                <label class="form-label">å„ªæƒ é¡å‹ *</label>
                <select class="form-select" id="pf_type" onchange="updatePromoFields()">
                    <option value="æ»¿ä»¶æŠ˜æ‰£">æ»¿ä»¶æŠ˜æ‰£</option>
                    <option value="æ»¿é¡æŠ˜æ‰£">æ»¿é¡æŠ˜æ‰£</option>
                    <option value="æ»¿é¡å…é‹">æ»¿é¡å…é‹</option>
                </select>
            </div>
            <div id="pf_unit_row" class="form-group">
                <label class="form-label">è¨ˆç®—å–®ä½</label>
                <select class="form-select" id="pf_unit">
                    <option value="æ¢">æ¢</option>
                    <option value="åŒ…">åŒ…</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" id="pf_threshold_label">é–€æª»æ•¸é‡ *</label>
                <input class="form-input" id="pf_threshold" type="number" min="0" placeholder="ä¾‹ï¼š5">
            </div>
            <div id="pf_discount_row" class="form-group">
                <label class="form-label">æŠ˜æ‰£é‡‘é¡ï¼ˆå…ƒï¼‰*</label>
                <input class="form-input" id="pf_discount" type="number" min="0" placeholder="ä¾‹ï¼š20">
            </div>
            <div class="form-group">
                <label class="form-label">å•Ÿç”¨ç‹€æ…‹</label>
                <select class="form-select" id="pf_enabled">
                    <option value="æ˜¯">âœ… å•Ÿç”¨</option>
                    <option value="å¦">âŒ åœç”¨</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">èªªæ˜æ–‡å­—</label>
                <input class="form-input" id="pf_desc" type="text" placeholder="ä¾‹ï¼šè²·5æ¢ä»¥ä¸Šæ¯æ¢æŠ˜4å…ƒ">
            </div>
            <div class="form-group">
                <label class="form-label">é©ç”¨é¡åˆ¥ <span style="color:#555;">ï¼ˆç©ºç™½ï¼å…¨éƒ¨ï¼Œå¤šå€‹ç”¨é€—è™Ÿåˆ†éš”ï¼‰</span></label>
                <input class="form-input" id="pf_categories" type="text" placeholder="ä¾‹ï¼šç³–æœ,é›¶é£Ÿ">
            </div>
            <div class="form-group">
                <label class="form-label">é©ç”¨è¦æ ¼ <span style="color:#555;">ï¼ˆç©ºç™½ï¼å…¨éƒ¨ï¼Œå¡«ï¼šå–®åŒ… æˆ– æ¢ï¼‰</span></label>
                <input class="form-input" id="pf_specs" type="text" placeholder="ä¾‹ï¼šæ¢">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-gray" onclick="closePromoModal()" style="background:rgba(255,255,255,0.05);border:1px solid #333;color:#999;">å–æ¶ˆ</button>
            <button class="btn btn-purple" onclick="savePromo()">ğŸ’¾ å„²å­˜</button>
        </div>
    </div>
</div>

<!-- ========== å…¬å‘Š Modal ========== -->
<div class="modal-overlay" id="annModal">
    <div class="modal-box">
        <div class="modal-header">
            <div class="modal-title" id="annModalTitle">æ–°å¢å…¬å‘Š</div>
            <button class="modal-close" onclick="closeAnnModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="af_rowIndex">
            <div class="form-group">
                <label class="form-label">å…¬å‘Šå…§å®¹ *</label>
                <textarea class="form-textarea" id="af_text" placeholder="è¼¸å…¥å…¬å‘Šæ–‡å­—..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">å•Ÿç”¨ç‹€æ…‹</label>
                <select class="form-select" id="af_enabled">
                    <option value="æ˜¯">âœ… å•Ÿç”¨</option>
                    <option value="å¦">âŒ åœç”¨</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">é€£çµç¶²å€ <span style="color:#555;">ï¼ˆé¸å¡«ï¼‰</span></label>
                <input class="form-input" id="af_link" type="url" placeholder="https://...">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeAnnModal()" style="background:rgba(255,255,255,0.05);border:1px solid #333;color:#999;">å–æ¶ˆ</button>
            <button class="btn btn-purple" onclick="saveAnn()">ğŸ’¾ å„²å­˜</button>
        </div>
    </div>
</div>

<!-- ========== è¨‚å–®è©³æƒ… Modal ========== -->
<div class="modal-overlay" id="orderModal">
    <div class="modal-box" style="max-width:640px;">
        <div class="modal-header">
            <div class="modal-title">ğŸ“‹ è¨‚å–®è©³æƒ…</div>
            <button class="modal-close" onclick="closeOrderModal()">Ã—</button>
        </div>
        <div class="modal-body" id="orderModalBody"></div>
        <div class="modal-footer" style="flex-direction:column; align-items:stretch; gap:12px;">
            <div style="background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:10px; padding:14px;">
                <div style="font-size:12px; color:#888; margin-bottom:10px; font-weight:700;">ğŸ“ æ›´æ–°è¨‚å–®ç‹€æ…‹</div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                    <select class="form-select" id="orderStatusSelect" style="flex:1; min-width:150px; padding:9px 14px;">
                        <option value="å¾…ç¢ºèª">å¾…ç¢ºèª</option>
                        <option value="å·²ä»˜æ¬¾å¾…å‡ºè²¨">å·²ä»˜æ¬¾å¾…å‡ºè²¨</option>
                        <option value="å‡ºè²¨ä¸­">å‡ºè²¨ä¸­</option>
                        <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                        <option value="å–æ¶ˆè¨‚å–®">å–æ¶ˆè¨‚å–®</option>
                    </select>
                    <button class="btn btn-purple" id="orderStatusSaveBtn" onclick="saveOrderStatus()">ğŸ’¾ å„²å­˜ç‹€æ…‹</button>
                </div>
            </div>
            <button class="btn" onclick="closeOrderModal()" style="background:rgba(255,255,255,0.05);border:1px solid #333;color:#999;">é—œé–‰</button>
        </div>
    </div>
</div>


<!-- ========== æ–°å¢å•†å“ Modal ========== -->
<div class="modal-overlay" id="addProductModal">
    <div class="modal-box" style="max-width:580px;">
        <div class="modal-header">
            <div class="modal-title">ï¼‹ æ–°å¢å•†å“</div>
            <button class="modal-close" onclick="closeAddProductModal()">Ã—</button>
        </div>
        <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
            <!-- åŸºæœ¬è³‡è¨Š -->
            <div style="font-size:11px;font-weight:900;color:#888;letter-spacing:1px;margin-bottom:12px;">ğŸ“‹ åŸºæœ¬è³‡è¨Š</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div class="form-group">
                    <label class="form-label">å•†å“ç·¨è™Ÿ
                        <button onclick="genProductId()" style="margin-left:6px;background:rgba(167,139,250,0.15);border:1px solid #a78bfa;color:#a78bfa;padding:2px 8px;border-radius:6px;font-size:11px;cursor:pointer;">ğŸ² è‡ªå‹•ç”Ÿæˆ</button>
                    </label>
                    <input class="form-input" id="np_id" placeholder="ä¾‹ï¼šP001">
                </div>
                <div class="form-group">
                    <label class="form-label">å•†å“åç¨± *</label>
                    <input class="form-input" id="np_name" placeholder="ä¾‹ï¼šMEVIUS æ°´æœç³»åˆ—">
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div class="form-group">
                    <label class="form-label">å•†å“é¡åˆ¥</label>
                    <select class="form-select" id="np_category_sel" onchange="handleComboChange('np_category_sel','np_category','np_category_custom'); autofillTagsByCategory('np')">
                        <option value="">â”€â”€ è«‹é¸æ“‡æˆ–è‡ªè¨‚ â”€â”€</option>
                    </select>
                    <input class="form-input" id="np_category" style="display:none;margin-top:6px;" placeholder="è¼¸å…¥è‡ªè¨‚é¡åˆ¥">
                    <input type="hidden" id="np_category_custom" value="">
                </div>
                <div class="form-group">
                    <label class="form-label">å¤§åˆ†é¡æ¨™ç±¤ <span style="color:#555;">ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</span></label>
                    <select class="form-select" id="np_tags_sel" onchange="handleComboChange('np_tags_sel','np_tags','np_tags_custom')">
                        <option value="">â”€â”€ è«‹é¸æ“‡æˆ–è‡ªè¨‚ â”€â”€</option>
                    </select>
                    <input class="form-input" id="np_tags" style="display:none;margin-top:6px;" placeholder="ä¾‹ï¼šæ–°å“,ç†±éŠ·">
                    <input type="hidden" id="np_tags_custom" value="">
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div class="form-group">
                    <label class="form-label">åœ–ç‰‡ç¶²å€</label>
                    <input class="form-input" id="np_image" placeholder="https://... æˆ–è²¼ä¸Š Google Drive åˆ†äº«é€£çµ" oninput="autoConvertDriveUrl('np_image')">
                </div>
                <div class="form-group">
                    <label class="form-label">è‡ªå®šç¾©å€å¡Š <span style="color:#555;">ï¼ˆå¯ç©ºç™½ï¼‰</span></label>
                    <select class="form-select" id="np_block_sel" onchange="handleComboChange('np_block_sel','np_block','np_block_custom')">
                        <option value="">â”€â”€ ç©ºç™½ï¼ˆä¸è¨­å®šï¼‰â”€â”€</option>
                    </select>
                    <input class="form-input" id="np_block" style="display:none;margin-top:6px;" placeholder="è¼¸å…¥è‡ªè¨‚å€å¡Šåç¨±">
                    <input type="hidden" id="np_block_custom" value="">
                </div>
            </div>
            <div class="form-group">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" id="np_featured" style="width:16px;height:16px;accent-color:#FFD700;">
                    <span class="form-label" style="margin:0;">è¨­ç‚ºä¸»æ‰“å•†å“</span>
                </label>
            </div>

            <!-- è¦æ ¼è¨­å®š -->
            <div style="border-top:1px solid rgba(255,255,255,0.08);padding-top:16px;margin-top:4px;">
                <div style="font-size:11px;font-weight:900;color:#888;letter-spacing:1px;margin-bottom:12px;">ğŸ“¦ è¦æ ¼è¨­å®š</div>
                <div style="font-size:12px;color:#666;margin-bottom:12px;">é¸æ“‡è¦æ–°å¢å“ªäº›è¦æ ¼ï¼Œå¯è¤‡é¸ã€‚æ¢å’ŒåŒ…è¦åˆ†åˆ¥å¡«é‡‘é¡ã€‚</div>

                <!-- å–®åŒ… -->
                <div class="spec-block" id="spec_block_å–®åŒ…">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:10px;">
                        <input type="checkbox" id="spec_check_å–®åŒ…" checked style="width:16px;height:16px;accent-color:#FFD700;" onchange="toggleSpecBlock('å–®åŒ…')">
                        <span style="font-weight:900;color:#FFD700;">å–®åŒ…</span>
                    </label>
                    <div id="spec_fields_å–®åŒ…" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;padding:12px;background:rgba(255,255,255,0.03);border-radius:10px;margin-bottom:14px;">
                        <div class="form-group" style="margin:0;">
                            <label class="form-label">åŸåƒ¹ï¼ˆå…ƒï¼‰*</label>
                            <input class="form-input" id="spec_price_å–®åŒ…" type="number" min="0" placeholder="ä¾‹ï¼š50">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label class="form-label">ç‰¹åƒ¹ <span style="color:#555;">ï¼ˆé¸å¡«ï¼‰</span></label>
                            <input class="form-input" id="spec_sale_å–®åŒ…" type="number" min="0" placeholder="ç©ºç™½ï¼ç„¡ç‰¹åƒ¹">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label class="form-label">åˆå§‹åº«å­˜</label>
                            <input class="form-input" id="spec_stock_å–®åŒ…" type="number" min="0" value="0">
                        </div>
                    </div>
                </div>

                <!-- æ¢ -->
                <div class="spec-block" id="spec_block_æ¢">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:10px;">
                        <input type="checkbox" id="spec_check_æ¢" style="width:16px;height:16px;accent-color:#FFD700;" onchange="toggleSpecBlock('æ¢')">
                        <span style="font-weight:900;color:#a78bfa;">æ¢</span>
                        <span style="font-size:11px;color:#555;">ï¼ˆ1æ¢ï¼10åŒ…ï¼Œé‡‘é¡éœ€åˆ†åˆ¥å¡«å¯«ï¼‰</span>
                    </label>
                    <div id="spec_fields_æ¢" style="display:none;grid-template-columns:1fr 1fr 1fr;gap:10px;padding:12px;background:rgba(255,255,255,0.03);border-radius:10px;margin-bottom:14px;">
                        <div class="form-group" style="margin:0;">
                            <label class="form-label">åŸåƒ¹ï¼ˆå…ƒï¼‰*</label>
                            <input class="form-input" id="spec_price_æ¢" type="number" min="0" placeholder="ä¾‹ï¼š450">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label class="form-label">ç‰¹åƒ¹ <span style="color:#555;">ï¼ˆé¸å¡«ï¼‰</span></label>
                            <input class="form-input" id="spec_sale_æ¢" type="number" min="0" placeholder="ç©ºç™½ï¼ç„¡ç‰¹åƒ¹">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label class="form-label">åˆå§‹åº«å­˜</label>
                            <div style="padding:10px 14px;background:rgba(255,255,255,0.03);border:1.5px solid rgba(255,255,255,0.1);border-radius:10px;font-size:13px;color:#888;">ğŸ”— è‡ªå‹•åŒæ­¥å–®åŒ…åº«å­˜</div>
                            <input type="hidden" id="spec_stock_æ¢" value="0">
                        </div>
                    </div>
                </div>

                <!-- å° -->
                <div class="spec-block" id="spec_block_å°">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:10px;">
                        <input type="checkbox" id="spec_check_å°" style="width:16px;height:16px;accent-color:#FFD700;" onchange="toggleSpecBlock('å°')">
                        <span style="font-weight:900;color:#34d399;">å°</span>
                    </label>
                    <div id="spec_fields_å°" style="display:none;grid-template-columns:1fr 1fr 1fr;gap:10px;padding:12px;background:rgba(255,255,255,0.03);border-radius:10px;margin-bottom:14px;">
                        <div class="form-group" style="margin:0;">
                            <label class="form-label">åŸåƒ¹ï¼ˆå…ƒï¼‰*</label>
                            <input class="form-input" id="spec_price_å°" type="number" min="0" placeholder="ä¾‹ï¼š4500">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label class="form-label">ç‰¹åƒ¹ <span style="color:#555;">ï¼ˆé¸å¡«ï¼‰</span></label>
                            <input class="form-input" id="spec_sale_å°" type="number" min="0" placeholder="ç©ºç™½ï¼ç„¡ç‰¹åƒ¹">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label class="form-label">åˆå§‹åº«å­˜</label>
                            <input class="form-input" id="spec_stock_å°" type="number" min="0" value="0">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeAddProductModal()" style="background:rgba(255,255,255,0.05);border:1px solid #333;color:#999;">å–æ¶ˆ</button>
            <button class="btn btn-purple" id="addProductSaveBtn" onclick="saveNewProduct()">ğŸ’¾ æ–°å¢å•†å“</button>
        </div>
    </div>
</div>

<!-- ========== åº«å­˜ç·¨è¼¯ Modal ========== -->
<div class="modal-overlay" id="stockModal">
    <div class="modal-box">
        <div class="modal-header">
            <div class="modal-title" id="stockModalTitle">âœï¸ ä¿®æ”¹åº«å­˜</div>
            <button class="modal-close" onclick="closeStockModal()">Ã—</button>
        </div>
        <div class="modal-body" id="stockModalBody"></div>
        <div class="modal-footer">
            <button class="btn" onclick="closeStockModal()" style="background:rgba(255,255,255,0.05);border:1px solid #333;color:#999;">å–æ¶ˆ</button>
            <button class="btn btn-purple" id="stockSaveBtn" onclick="saveStock()">ğŸ’¾ å„²å­˜</button>
        </div>
    </div>
</div>


<!-- ========== ç·¨è¼¯å•†å“ Modal ========== -->
<div class="modal-overlay" id="editProductModal">
    <div class="modal-box" style="max-width:600px;">
        <div class="modal-header">
            <div class="modal-title">âœï¸ ç·¨è¼¯å•†å“</div>
            <button class="modal-close" onclick="closeEditProductModal()">Ã—</button>
        </div>
        <div class="modal-body" style="max-height:75vh;overflow-y:auto;">
            <!-- åŸºæœ¬è³‡è¨Š -->
            <div style="font-size:11px;font-weight:900;color:#888;letter-spacing:1px;margin-bottom:12px;">ğŸ“‹ åŸºæœ¬è³‡è¨Š</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div class="form-group">
                    <label class="form-label">å•†å“ç·¨è™Ÿ</label>
                    <input class="form-input" id="ep_id" disabled style="opacity:0.5;">
                </div>
                <div class="form-group">
                    <label class="form-label">å•†å“åç¨± *</label>
                    <input class="form-input" id="ep_name" placeholder="ä¾‹ï¼šMEVIUS æ°´æœç³»åˆ—">
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div class="form-group">
                    <label class="form-label">å•†å“é¡åˆ¥</label>
                    <select class="form-select" id="ep_category_sel" onchange="handleComboChange('ep_category_sel','ep_category','ep_category_c'); autofillTagsByCategory('ep')">
                        <option value="">â”€â”€ è«‹é¸æ“‡é¡åˆ¥ â”€â”€</option>
                    </select>
                    <input class="form-input" id="ep_category" style="display:none;margin-top:6px;" placeholder="è¼¸å…¥è‡ªè¨‚é¡åˆ¥">
                    <input type="hidden" id="ep_category_c">
                </div>
                <div class="form-group">
                    <label class="form-label">åˆ†é¡æ¨™ç±¤ <span style="color:#555;">ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</span></label>
                    <select class="form-select" id="ep_tags_sel" onchange="handleComboChange('ep_tags_sel','ep_tags','ep_tags_c')">
                        <option value="">â”€â”€ è«‹é¸æ“‡æ¨™ç±¤ â”€â”€</option>
                    </select>
                    <input class="form-input" id="ep_tags" style="display:none;margin-top:6px;" placeholder="ä¾‹ï¼šæ–°å“,ç†±éŠ·">
                    <input type="hidden" id="ep_tags_c">
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div class="form-group">
                    <label class="form-label">åœ–ç‰‡ç¶²å€ <span style="color:#555;">ï¼ˆæ”¯æ´ Google Drive é€£çµï¼‰</span></label>
                    <input class="form-input" id="ep_image" placeholder="https://... æˆ–è²¼ä¸Š Google Drive åˆ†äº«é€£çµ" oninput="autoConvertDriveUrl('ep_image')">
                    <div id="ep_image_preview" style="margin-top:8px;display:none;">
                        <img id="ep_image_thumb" style="max-width:100%;max-height:120px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">è‡ªå®šç¾©å€å¡Š <span style="color:#555;">ï¼ˆå¯ç©ºç™½ï¼‰</span></label>
                    <select class="form-select" id="ep_block_sel" onchange="handleComboChange('ep_block_sel','ep_block','ep_block_c')">
                        <option value="">â”€â”€ ç©ºç™½ï¼ˆä¸è¨­å®šï¼‰â”€â”€</option>
                    </select>
                    <input class="form-input" id="ep_block" style="display:none;margin-top:6px;" placeholder="è¼¸å…¥è‡ªè¨‚å€å¡Šåç¨±">
                    <input type="hidden" id="ep_block_c">
                </div>
            </div>
            <div class="form-group">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" id="ep_featured" style="width:16px;height:16px;accent-color:#FFD700;">
                    <span class="form-label" style="margin:0;">è¨­ç‚ºä¸»æ‰“å•†å“</span>
                </label>
            </div>

            <!-- è¦æ ¼åƒ¹æ ¼ -->
            <div style="border-top:1px solid rgba(255,255,255,0.08);padding-top:16px;margin-top:4px;">
                <div style="font-size:11px;font-weight:900;color:#888;letter-spacing:1px;margin-bottom:12px;">ğŸ’° è¦æ ¼åƒ¹æ ¼</div>
                <div id="ep_specs_list"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeEditProductModal()" style="background:rgba(255,255,255,0.05);border:1px solid #333;color:#999;">å–æ¶ˆ</button>
            <button class="btn btn-purple" id="editProductSaveBtn" onclick="saveEditProduct()">ğŸ’¾ å„²å­˜å•†å“</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
// ==========================================
// è¨­å®š
// ==========================================
// âœ… é‡‘é‘°å·²ç§»è‡³ Vercel ç’°å¢ƒè®Šæ•¸ï¼Œå‰ç«¯ä¸å†æš´éœ²ä»»ä½• API Key
// LINE_CHANNEL_ID ç‚ºå…¬é–‹çš„ Client IDï¼Œé secretï¼Œå¯ä¿ç•™å‰ç«¯
const LINE_CHANNEL_ID   = '2009217612';
const LINE_REDIRECT_URI = location.origin + '/admin-callback.html';

// æˆæ¬Šç®¡ç†å“¡ LINE ID æ¸…å–®
const ADMIN_LINE_IDS  = [
    'U87ca3fb624660978917d3cb9fc24a0f0'
];

const PROMO_SHEET = 'å„ªæƒ è¨­å®š';
const CATEGORY_SHEET = 'åˆ†é¡è¨­å®š';
const SYSTEM_SHEET   = 'ç³»çµ±è¨­å®š';

const ANN_SHEET   = 'å…¬å‘Šè¨­å®š';

let adminMember  = null;
let allPromos    = [];   // {rowIndex, name, type, unit, threshold, discount, enabled, desc, categories, specs}
let allAnns      = [];   // {rowIndex, text, enabled, link}
let allMembers   = [];
let allOrders    = [];
let filteredMembers = [];
let filteredOrders  = [];

// ==========================================
// LINE ç™»å…¥
// ==========================================
function lineLogin() {
    const state = 'admin_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('admin_line_state', state);
    const url = `https://access.line.me/oauth2/v2.1/authorize?` +
        `response_type=code&client_id=${LINE_CHANNEL_ID}` +
        `&redirect_uri=${encodeURIComponent(LINE_REDIRECT_URI)}` +
        `&state=${state}&scope=profile%20openid`;
    window.location.href = url;
}

function adminLogout() {
    if (!confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) return;
    adminMember = null;
    localStorage.removeItem('admin_member');
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
}

// ==========================================
// åˆå§‹åŒ–
// ==========================================
async function init() {
    // 1. å˜—è©¦å¾ localStorage è®€å–å·²ç™»å…¥è³‡æ–™
    const saved = localStorage.getItem('admin_member');
    if (saved) {
        try { adminMember = JSON.parse(saved); } catch(e) { adminMember = null; }
    }

    // 2. å¦‚æœ URL å¸¶æœ‰ access_token (å¾ callback è·³å›)
    const params = new URLSearchParams(location.search);
    if (params.has('access_token')) {
        const token = params.get('access_token');
        const name  = decodeURIComponent(params.get('name') || '');
        const pic   = decodeURIComponent(params.get('picture') || '');
        const lineId = decodeURIComponent(params.get('lineId') || '');
        adminMember = { lineId, displayName: name, pictureUrl: pic };
        localStorage.setItem('admin_member', JSON.stringify(adminMember));
        // æ¸…æ‰ URL åƒæ•¸
        history.replaceState({}, '', location.pathname);
    }

    if (!adminMember || !adminMember.lineId) {
        showLogin(); return;
    }

    // 3. é©—è­‰æ˜¯å¦ç‚ºæˆæ¬Šç®¡ç†å“¡
    if (!ADMIN_LINE_IDS.includes(adminMember.lineId)) {
        alert('â›” æ‚¨æ²’æœ‰å¾Œå°ç®¡ç†å“¡æ¬Šé™');
        adminMember = null;
        localStorage.removeItem('admin_member');
        showLogin(); return;
    }

    showMain();
}

function showLogin() {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('mainApp').style.display = 'none';
}

function showMain() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('adminAvatar').src = adminMember.pictureUrl || '';
    document.getElementById('adminName').textContent = adminMember.displayName || 'ç®¡ç†å“¡';
    switchTab('orders');
    loadMaintenanceStatus();
}

// ==========================================
// Tab åˆ‡æ›
// ==========================================
let currentTab = 'orders';

function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    document.getElementById('page-' + tab).classList.add('active');
    currentTab = tab;

    if (tab === 'orders')        loadOrders();
    if (tab === 'stock')         loadStock();
    if (tab === 'announcements') loadAnnouncements();
    if (tab === 'promos')        loadPromos();
    if (tab === 'members')       loadMembers();
}

function reloadCurrentTab() {
    switchTab(currentTab);
}

// ==========================================
// å·¥å…·å‡½å¼
// ==========================================
function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'show ' + type;
    clearTimeout(t._timer);
    t._timer = setTimeout(() => { t.className = ''; }, 3000);
}

async function sheetsRead(sheetName) {
    const res = await fetch(`/api/sheets?sheet=${encodeURIComponent(sheetName)}`);
    if (!res.ok) throw new Error('è®€å–å¤±æ•—: ' + sheetName);
    return await res.json();
}

// é€é Apps Script GET å¯«å…¥ï¼ˆå¯å–å¾—å›å‚³å€¼ï¼Œç¢ºèªæˆåŠŸ/å¤±æ•—ï¼‰
async function scriptPost(payload) {
    const res = await fetch('/api/script', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    const result = await res.json();
    if (!result.success) throw new Error(result.error || 'æ“ä½œå¤±æ•—');
    return result;
}

// ==========================================
// ğŸ å„ªæƒ è¨­å®š
// ==========================================
async function loadPromos() {
    document.getElementById('promoList').innerHTML =
        `<div class="loading-state"><div class="icon">â³</div><div>è¼‰å…¥ä¸­...</div></div>`;
    try {
        const data = await sheetsRead(PROMO_SHEET);
        if (!data.values || data.values.length < 2) {
            allPromos = [];
            renderPromos(); return;
        }
        allPromos = data.values.slice(1).map((row, i) => ({
            rowIndex: i + 2, // Google Sheets å¾ç¬¬2è¡Œèµ·ï¼ˆç¬¬1è¡Œæ˜¯æ¨™é¡Œï¼‰
            name:       row[0] || '',
            type:       row[1] || 'æ»¿ä»¶æŠ˜æ‰£',
            unit:       row[2] || 'æ¢',
            threshold:  row[3] || '',
            discount:   row[4] || '',
            enabled:    row[5] || 'å¦',
            desc:       row[6] || '',
            categories: row[7] || '',
            specs:      row[8] || ''
        })).filter(p => p.name);
        renderPromos();
    } catch(e) {
        document.getElementById('promoList').innerHTML =
            `<div class="loading-state"><div class="icon">âŒ</div><div>è¼‰å…¥å¤±æ•—ï¼š${e.message}</div></div>`;
    }
}

function renderPromos() {
    const el = document.getElementById('promoList');
    if (allPromos.length === 0) {
        el.innerHTML = `<div class="loading-state"><div class="icon">ğŸ</div><div>å°šç„¡å„ªæƒ è¦å‰‡</div></div>`;
        return;
    }
    el.innerHTML = allPromos.map((p, idx) => `
        <div class="card">
            <div class="promo-card">
                <div class="promo-info">
                    <div class="promo-name">${escHtml(p.name)}</div>
                    <div class="promo-meta">
                        é¡å‹ï¼š${escHtml(p.type)}ã€€
                        ${p.type === 'æ»¿ä»¶æŠ˜æ‰£' ? `å–®ä½ï¼š${escHtml(p.unit)}ã€€é–€æª»ï¼š${p.threshold}ä»¶ã€€æŠ˜æ‰£ï¼š$${p.discount}` :
                          p.type === 'æ»¿é¡æŠ˜æ‰£' ? `é–€æª»ï¼š$${p.threshold}ã€€æŠ˜æ‰£ï¼š$${p.discount}` :
                          `é–€æª»ï¼š$${p.threshold}ã€€ï¼ˆå…é‹ï¼‰`}
                        ${p.desc ? `<br>èªªæ˜ï¼š${escHtml(p.desc)}` : ''}
                        ${p.categories ? `<br>é©ç”¨é¡åˆ¥ï¼š${escHtml(p.categories)}` : ''}
                        ${p.specs ? `<br>é©ç”¨è¦æ ¼ï¼š${escHtml(p.specs)}` : ''}
                    </div>
                </div>
                <div class="promo-actions">
                    <span class="badge ${p.enabled === 'æ˜¯' ? 'badge-green' : 'badge-gray'}">
                        ${p.enabled === 'æ˜¯' ? 'âœ… å•Ÿç”¨' : 'âŒ åœç”¨'}
                    </span>
                    <button class="btn btn-yellow btn-sm" onclick="openPromoModal(${idx})">âœï¸ ç·¨è¼¯</button>
                    <button class="btn btn-red btn-sm" onclick="deletePromo(${idx})">ğŸ—‘ï¸</button>
                </div>
            </div>
        </div>
    `).join('');
}

function openPromoModal(idx) {
    const isEdit = idx !== undefined;
    document.getElementById('promoModalTitle').textContent = isEdit ? 'âœï¸ ç·¨è¼¯å„ªæƒ ' : 'ï¼‹ æ–°å¢å„ªæƒ ';
    if (isEdit) {
        const p = allPromos[idx];
        document.getElementById('pf_rowIndex').value  = p.rowIndex;
        document.getElementById('pf_name').value       = p.name;
        document.getElementById('pf_type').value       = p.type;
        document.getElementById('pf_unit').value       = p.unit || 'æ¢';
        document.getElementById('pf_threshold').value  = p.threshold;
        document.getElementById('pf_discount').value   = p.discount;
        document.getElementById('pf_enabled').value    = p.enabled;
        document.getElementById('pf_desc').value       = p.desc;
        document.getElementById('pf_categories').value = p.categories;
        document.getElementById('pf_specs').value      = p.specs;
    } else {
        document.getElementById('pf_rowIndex').value  = '';
        document.getElementById('pf_name').value       = '';
        document.getElementById('pf_type').value       = 'æ»¿ä»¶æŠ˜æ‰£';
        document.getElementById('pf_unit').value       = 'æ¢';
        document.getElementById('pf_threshold').value  = '';
        document.getElementById('pf_discount').value   = '';
        document.getElementById('pf_enabled').value    = 'æ˜¯';
        document.getElementById('pf_desc').value       = '';
        document.getElementById('pf_categories').value = '';
        document.getElementById('pf_specs').value      = '';
    }
    updatePromoFields();
    document.getElementById('promoModal').classList.add('active');
}

function closePromoModal() {
    document.getElementById('promoModal').classList.remove('active');
}

function updatePromoFields() {
    const type = document.getElementById('pf_type').value;
    document.getElementById('pf_unit_row').style.display     = type === 'æ»¿ä»¶æŠ˜æ‰£' ? '' : 'none';
    document.getElementById('pf_discount_row').style.display = type === 'æ»¿é¡å…é‹' ? 'none' : '';
    document.getElementById('pf_threshold_label').textContent =
        type === 'æ»¿ä»¶æŠ˜æ‰£' ? 'é–€æª»æ•¸é‡ï¼ˆä»¶ï¼‰*' : 'é–€æª»é‡‘é¡ï¼ˆå…ƒï¼‰*';
}

async function savePromo() {
    const name      = document.getElementById('pf_name').value.trim();
    const type      = document.getElementById('pf_type').value;
    const threshold = document.getElementById('pf_threshold').value.trim();
    if (!name)      { showToast('è«‹è¼¸å…¥å„ªæƒ åç¨±', 'error'); return; }
    if (!threshold) { showToast('è«‹è¼¸å…¥é–€æª»å€¼', 'error'); return; }

    const rowIndex = document.getElementById('pf_rowIndex').value;
    const saveBtn  = document.querySelector('#promoModal .modal-footer .btn-purple');
    const origText = saveBtn.textContent;
    saveBtn.disabled = true;
    saveBtn.textContent = 'å„²å­˜ä¸­...';

    const payload = {
        action:   rowIndex ? 'adminUpdatePromo' : 'adminAddPromo',
        rowIndex: rowIndex ? parseInt(rowIndex) : null,
        adminLineId: adminMember.lineId,
        promo: {
            name, type,
            unit:       document.getElementById('pf_unit').value,
            threshold,
            discount:   document.getElementById('pf_discount').value.trim(),
            enabled:    document.getElementById('pf_enabled').value,
            desc:       document.getElementById('pf_desc').value.trim(),
            categories: document.getElementById('pf_categories').value.trim(),
            specs:      document.getElementById('pf_specs').value.trim()
        }
    };

    try {
        await scriptPost(payload);
        closePromoModal();
        showToast(rowIndex ? 'âœ… å„ªæƒ å·²æ›´æ–°ï¼' : 'âœ… å„ªæƒ å·²æ–°å¢ï¼');
        await loadPromos();  // ç­‰å¾…åˆ·æ–°å®Œæˆï¼Œä¸é  setTimeout
    } catch(e) {
        showToast('âŒ ' + e.message, 'error');
        saveBtn.disabled = false;
        saveBtn.textContent = origText;
    }
}

async function deletePromo(idx) {
    const p = allPromos[idx];
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${p.name}ã€å—ï¼Ÿ`)) return;
    try {
        await scriptPost({ action: 'adminDeleteRow', sheet: PROMO_SHEET, rowIndex: p.rowIndex, adminLineId: adminMember.lineId });
        showToast('âœ… å·²åˆªé™¤å„ªæƒ ');
        await loadPromos();
    } catch(e) {
        showToast('âŒ åˆªé™¤å¤±æ•—ï¼š' + e.message, 'error');
    }
}

// ==========================================
// ğŸ“¢ å…¬å‘Šç®¡ç†
// ==========================================
async function loadAnnouncements() {
    document.getElementById('annList').innerHTML =
        `<div class="loading-state"><div class="icon">â³</div><div>è¼‰å…¥ä¸­...</div></div>`;
    try {
        const data = await sheetsRead(ANN_SHEET);
        if (!data.values || data.values.length < 2) {
            allAnns = []; renderAnns(); return;
        }
        allAnns = data.values.slice(1).map((row, i) => ({
            rowIndex: i + 2,
            text:     row[0] || '',
            enabled:  row[1] || 'å¦',
            link:     row[2] || ''
        })).filter(a => a.text);
        renderAnns();
    } catch(e) {
        document.getElementById('annList').innerHTML =
            `<div class="loading-state"><div class="icon">âŒ</div><div>è¼‰å…¥å¤±æ•—ï¼š${e.message}</div></div>`;
    }
}

function renderAnns() {
    const el = document.getElementById('annList');
    if (allAnns.length === 0) {
        el.innerHTML = `<div class="loading-state"><div class="icon">ğŸ“¢</div><div>å°šç„¡å…¬å‘Š</div></div>`;
        return;
    }
    el.innerHTML = allAnns.map((a, idx) => `
        <div class="card">
            <div class="ann-card">
                <div style="flex:1; min-width:0;">
                    <div class="ann-text">${escHtml(a.text)}</div>
                    ${a.link ? `<div class="ann-link">ğŸ”— ${escHtml(a.link)}</div>` : ''}
                </div>
                <div style="display:flex; align-items:center; gap:8px; flex-shrink:0;">
                    <span class="badge ${a.enabled === 'æ˜¯' ? 'badge-green' : 'badge-gray'}">
                        ${a.enabled === 'æ˜¯' ? 'âœ… å•Ÿç”¨' : 'âŒ åœç”¨'}
                    </span>
                    <button class="btn btn-yellow btn-sm" onclick="openAnnModal(${idx})">âœï¸</button>
                    <button class="btn btn-red btn-sm" onclick="deleteAnn(${idx})">ğŸ—‘ï¸</button>
                </div>
            </div>
        </div>
    `).join('');
}

function openAnnModal(idx) {
    const isEdit = idx !== undefined;
    document.getElementById('annModalTitle').textContent = isEdit ? 'âœï¸ ç·¨è¼¯å…¬å‘Š' : 'ï¼‹ æ–°å¢å…¬å‘Š';
    if (isEdit) {
        const a = allAnns[idx];
        document.getElementById('af_rowIndex').value = a.rowIndex;
        document.getElementById('af_text').value     = a.text;
        document.getElementById('af_enabled').value  = a.enabled;
        document.getElementById('af_link').value     = a.link;
    } else {
        document.getElementById('af_rowIndex').value = '';
        document.getElementById('af_text').value     = '';
        document.getElementById('af_enabled').value  = 'æ˜¯';
        document.getElementById('af_link').value     = '';
    }
    document.getElementById('annModal').classList.add('active');
}

function closeAnnModal() { document.getElementById('annModal').classList.remove('active'); }

async function saveAnn() {
    const text = document.getElementById('af_text').value.trim();
    if (!text) { showToast('è«‹è¼¸å…¥å…¬å‘Šå…§å®¹', 'error'); return; }
    const rowIndex = document.getElementById('af_rowIndex').value;
    const saveBtn  = document.querySelector('#annModal .modal-footer .btn-purple');
    const origText = saveBtn.textContent;
    saveBtn.disabled = true;
    saveBtn.textContent = 'å„²å­˜ä¸­...';
    const payload = {
        action:   rowIndex ? 'adminUpdateAnn' : 'adminAddAnn',
        rowIndex: rowIndex ? parseInt(rowIndex) : null,
        adminLineId: adminMember.lineId,
        ann: {
            text,
            enabled: document.getElementById('af_enabled').value,
            link:    document.getElementById('af_link').value.trim()
        }
    };
    try {
        await scriptPost(payload);
        closeAnnModal();
        showToast(rowIndex ? 'âœ… å…¬å‘Šå·²æ›´æ–°ï¼' : 'âœ… å…¬å‘Šå·²æ–°å¢ï¼');
        await loadAnnouncements();
    } catch(e) {
        showToast('âŒ ' + e.message, 'error');
        saveBtn.disabled = false;
        saveBtn.textContent = origText;
    }
}

async function deleteAnn(idx) {
    const a = allAnns[idx];
    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡å…¬å‘Šå—ï¼Ÿ')) return;
    try {
        await scriptPost({ action: 'adminDeleteRow', sheet: ANN_SHEET, rowIndex: a.rowIndex, adminLineId: adminMember.lineId });
        showToast('âœ… å…¬å‘Šå·²åˆªé™¤');
        await loadAnnouncements();
    } catch(e) {
        showToast('âŒ åˆªé™¤å¤±æ•—ï¼š' + e.message, 'error');
    }
}

// ==========================================
// ğŸ‘¥ æœƒå“¡ç®¡ç†
// ==========================================
async function loadMembers() {
    document.getElementById('memberList').innerHTML =
        `<div class="loading-state"><div class="icon">â³</div><div>è¼‰å…¥ä¸­...</div></div>`;
    try {
        const res = await fetch(`/api/script-get?action=getAllMembers&adminLineId=${encodeURIComponent(adminMember.lineId)}`);
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'è®€å–å¤±æ•—');
        allMembers = data.members || [];
        filteredMembers = [...allMembers];
        renderMembers();
    } catch(e) {
        document.getElementById('memberList').innerHTML =
            `<div class="loading-state"><div class="icon">âŒ</div><div>è¼‰å…¥å¤±æ•—ï¼š${e.message}<br><span style="font-size:12px;color:#555;">è«‹ç¢ºèª Apps Script å·²æ”¯æ´ getAllMembers action</span></div></div>`;
    }
}

function filterMembers() {
    const kw     = document.getElementById('memberSearch').value.trim().toLowerCase();
    const status = document.getElementById('memberStatusFilter').value;
    filteredMembers = allMembers.filter(m => {
        const matchKw = !kw ||
            (m.displayName || '').toLowerCase().includes(kw) ||
            (m.phone || '').includes(kw) ||
            (m.lineId || '').toLowerCase().includes(kw);
        const matchStatus = !status || (m.approvalStatus || 'å¾…å¯©æ ¸') === status;
        return matchKw && matchStatus;
    });
    renderMembers();
}

function renderMembers() {
    const el = document.getElementById('memberList');
    if (filteredMembers.length === 0) {
        el.innerHTML = `<div class="loading-state"><div class="icon">ğŸ‘¥</div><div>æ²’æœ‰ç¬¦åˆçš„æœƒå“¡</div></div>`;
        return;
    }
    el.innerHTML = filteredMembers.map((m, idx) => {
        const status = m.approvalStatus || 'å¾…å¯©æ ¸';
        const badgeClass = status === 'å·²é€šé' ? 'badge-green' : status === 'å·²æ‹’çµ•' ? 'badge-red' : 'badge-yellow';
        return `
        <div class="card">
            <div class="member-row">
                <img class="member-avatar" src="${escHtml(m.pictureUrl || '')}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\'%3E%3C/svg%3E'" alt="">
                <div class="member-info">
                    <div class="member-name">${escHtml(m.displayName || 'ï¼ˆæœªè¨­å®šï¼‰')}</div>
                    <div class="member-sub">
                        ğŸ“± ${escHtml(m.phone || 'æœªè¨­å®š')}ã€€
                        ğŸ“§ ${escHtml(m.email || 'æœªè¨­å®š')}<br>
                        ğŸ†” <span style="font-size:11px; word-break:break-all;">${escHtml(m.lineId || '')}</span>
                    </div>
                </div>
                <div class="member-actions">
                    <span class="badge ${badgeClass}">${status}</span>
                    ${status !== 'å·²é€šé' ? `<button class="btn btn-green btn-sm" onclick="updateMemberStatus(${idx}, 'å·²é€šé')">âœ… é€šé</button>` : ''}
                    ${status !== 'å·²æ‹’çµ•' ? `<button class="btn btn-red btn-sm" onclick="updateMemberStatus(${idx}, 'å·²æ‹’çµ•')">âŒ æ‹’çµ•</button>` : ''}
                </div>
            </div>
        </div>`;
    }).join('');
}

async function updateMemberStatus(idx, newStatus) {
    const m = filteredMembers[idx];
    const label = newStatus === 'å·²é€šé' ? 'é€šé' : 'æ‹’çµ•';
    if (!confirm(`ç¢ºå®šè¦${label}ã€Œ${m.displayName}ã€çš„å¯©æ ¸å—ï¼Ÿ`)) return;
    try {
        await scriptPost({
            action: 'adminUpdateMemberStatus',
            adminLineId: adminMember.lineId,
            targetLineId: m.lineId,
            approvalStatus: newStatus
        });
        showToast(`å·²${label}æœƒå“¡å¯©æ ¸`);
        setTimeout(loadMembers, 1200);
    } catch(e) {
        showToast('æ“ä½œå¤±æ•—', 'error');
    }
}

// ==========================================
// ğŸ“‹ æ‰€æœ‰è¨‚å–®
// ==========================================
// â”€â”€ è¨‚å–®é ç¢¼ç‹€æ…‹ â”€â”€
const ORDER_PAGE_SIZE = 50;
let orderPage = 1;
let orderCacheTime = 0;
const ORDER_CACHE_TTL = 60000; // 1åˆ†é˜å…§åˆ‡æ›åˆ†é ä¸é‡è®€

async function loadOrders(forceReload = false) {
    const now = Date.now();
    const useCache = !forceReload && allOrders.length > 0 && (now - orderCacheTime) < ORDER_CACHE_TTL;

    if (!useCache) {
        // é¡¯ç¤ºéª¨æ¶å±
        document.getElementById('orderList').innerHTML = `
            <div style="display:flex;flex-direction:column;gap:10px;">
                ${[1,2,3,4,5].map(()=>`
                <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:16px;animation:pulse 1.2s infinite;">
                    <div style="height:14px;width:40%;background:rgba(255,255,255,0.07);border-radius:6px;margin-bottom:10px;"></div>
                    <div style="height:12px;width:70%;background:rgba(255,255,255,0.05);border-radius:6px;"></div>
                </div>`).join('')}
            </div>`;
        document.getElementById('orderStats').innerHTML = '';

        try {
            // ç›´æ¥ç”¨ Sheets API è®€ï¼Œè·³é Apps Script å†·å•Ÿå‹•
            const data = await sheetsRead('è¨‚å–®æ¸…å–®');
            const rows = (data.values || []).slice(1).filter(r => r[0]);
            allOrders = rows.map(r => ({
                è¨‚å–®ç·¨è™Ÿ: r[0]||'', è¨‚è³¼æ™‚é–“: r[1]||'', å§“å: r[2]||'', é›»è©±: r[3]||'',
                å–è²¨æ–¹å¼: r[4]||'', é–€å¸‚åç¨±: r[5]||'', é–€å¸‚åœ°å€: r[6]||'',
                åŒ¯æ¬¾æœ«äº”ç¢¼: r[7]||'-', å•†å“æ˜ç´°: r[8]||'', å•†å“é‡‘é¡: r[9]||0,
                é‹è²»: r[10]||0, ç¸½é‡‘é¡: r[11]||0, è¨‚å–®ç‹€æ…‹: r[12]||'',
                ç‰©æµç·¨è™Ÿ: r[13]||'-', æœƒå“¡ID: r[14]||'', ä»˜æ¬¾ç‹€æ…‹: r[15]||'',
                ä»˜æ¬¾æ–¹å¼: r[16]||'', é–€å¸‚ä»£ç¢¼: r[17]||''
            })).sort((a,b) => {
                try { return new Date(b.è¨‚è³¼æ™‚é–“) - new Date(a.è¨‚è³¼æ™‚é–“); } catch(e){ return 0; }
            });
            orderCacheTime = Date.now();
            orderPage = 1;
        } catch(e) {
            document.getElementById('orderList').innerHTML =
                `<div class="loading-state"><div class="icon">âŒ</div><div>è¼‰å…¥å¤±æ•—ï¼š${e.message}</div></div>`;
            return;
        }
    }

    applyOrderFilter();
}

function applyOrderFilter() {
    const kw     = (document.getElementById('orderSearch')?.value || '').trim().toLowerCase();
    const status = document.getElementById('orderStatusFilter')?.value || '';
    filteredOrders = allOrders.filter(o =>
        (!kw     || o.è¨‚å–®ç·¨è™Ÿ.toLowerCase().includes(kw) || o.å§“å.toLowerCase().includes(kw) || o.é›»è©±.includes(kw)) &&
        (!status || o.è¨‚å–®ç‹€æ…‹ === status)
    );
    renderOrderStats();
    renderOrders();
}

function renderOrderStats() {
    const total  = allOrders.length;
    const totalAmt = allOrders.reduce((s, o) => s + (parseFloat(o.ç¸½é‡‘é¡ || o.é‡‘é¡ || 0)), 0);
    const pending  = allOrders.filter(o => o.è¨‚å–®ç‹€æ…‹ === 'å¾…ç¢ºèª').length;
    const shipping = allOrders.filter(o => o.è¨‚å–®ç‹€æ…‹ === 'å·²ä»˜æ¬¾å¾…å‡ºè²¨').length;
    document.getElementById('orderStats').innerHTML = `
        <div class="stat-card"><div class="stat-num">${total}</div><div class="stat-label">ç¸½è¨‚å–®æ•¸</div></div>
        <div class="stat-card"><div class="stat-num" style="color:var(--primary);">$${totalAmt.toLocaleString()}</div><div class="stat-label">ç¸½é‡‘é¡</div></div>
        <div class="stat-card"><div class="stat-num" style="color:#ffa500;">${pending}</div><div class="stat-label">å¾…ç¢ºèª</div></div>
        <div class="stat-card"><div class="stat-num" style="color:#a78bfa;">${shipping}</div><div class="stat-label">å¾…å‡ºè²¨</div></div>
    `;
}

let currentOrderStatus = '';
let currentShipFilter  = '';

function setShipTab(el, ship) {
    currentShipFilter = ship;
    document.querySelectorAll('.ship-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    orderPage = 1;
    filterOrders();
}

function setOrderStatus(status) {
    currentOrderStatus = status;
    document.querySelectorAll('.order-pill').forEach(p => {
        p.classList.toggle('active', p.dataset.status === status);
    });
    orderPage = 1;
    filterOrders();
}

function filterOrders() {
    const kw     = document.getElementById('orderSearch').value.trim().toLowerCase();
    const status = document.getElementById('orderStatusFilter')?.value || '';
    filteredOrders = allOrders.filter(o => {
        if (status && o.è¨‚å–®ç‹€æ…‹ !== status) return false;
        const text    = JSON.stringify(o).toLowerCase();
        const matchKw = !kw || text.includes(kw);
        const matchSt = !currentOrderStatus || (o.è¨‚å–®ç‹€æ…‹ || '') === currentOrderStatus;
        const pickup  = String(o.å–è²¨æ–¹å¼ || '');
        const is711   = pickup.includes('7-11') || pickup.includes('711');
        const matchShip = !currentShipFilter
            || (currentShipFilter === '711'  && is711)
            || (currentShipFilter === 'self' && !is711);
        return matchKw && matchSt && matchShip;
    });
    renderOrders();
}

function renderOrders() {
    const el = document.getElementById('orderList');
    if (filteredOrders.length === 0) {
        el.innerHTML = `<div class="loading-state"><div class="icon">ğŸ“‹</div><div>æ²’æœ‰ç¬¦åˆçš„è¨‚å–®</div></div>`;
        return;
    }
    const total = filteredOrders.length;
    const totalPages = Math.ceil(total / ORDER_PAGE_SIZE);
    orderPage = Math.min(orderPage, totalPages);
    const slice = filteredOrders.slice((orderPage - 1) * ORDER_PAGE_SIZE, orderPage * ORDER_PAGE_SIZE);

    el.innerHTML = slice.map((o, i) => {
        const realIdx = (orderPage - 1) * ORDER_PAGE_SIZE + i;
        const status  = o.è¨‚å–®ç‹€æ…‹ || '';
        const statusBadge = status === 'å·²å®Œæˆ' ? 'badge-green'
            : (status === 'å–æ¶ˆè¨‚å–®' || status === 'è¨‚å–®å–æ¶ˆ') ? 'badge-red'
            : status === 'å‡ºè²¨ä¸­' ? 'badge-purple'
            : status === 'å·²ä»˜æ¬¾å¾…å‡ºè²¨' ? 'badge-yellow'
            : 'badge-gray';
        const amt     = o.ç¸½é‡‘é¡ || '-';
        const pickup  = String(o.å–è²¨æ–¹å¼ || '');
        const is711   = pickup.includes('7-11') || pickup.includes('711');
        const shipLabel = is711 ? 'ğŸª 7-11' : 'ğŸš¶ è‡ªå–';
        const shipClass = is711 ? 'ship-711' : 'ship-self';

        // å¿«é€Ÿæ“ä½œæŒ‰éˆ•ï¼ˆä¾ç¾åœ¨ç‹€æ…‹æ±ºå®šé¡¯ç¤ºå“ªäº›ï¼‰
        let quickBtns = `<button class="quick-btn q-detail" onclick="event.stopPropagation();showOrderDetail(${realIdx})">ğŸ“‹ è©³æƒ…</button>`;
        if (status !== 'å·²å®Œæˆ' && status !== 'å–æ¶ˆè¨‚å–®' && status !== 'è¨‚å–®å–æ¶ˆ') {
            if (status === 'å·²ä»˜æ¬¾å¾…å‡ºè²¨')
                quickBtns += `<button class="quick-btn q-ship" onclick="event.stopPropagation();quickStatus('${escHtml(o.è¨‚å–®ç·¨è™Ÿ)}','å‡ºè²¨ä¸­',${realIdx})">ğŸšš å‡ºè²¨</button>`;
            if (status === 'å‡ºè²¨ä¸­')
                quickBtns += `<button class="quick-btn q-done" onclick="event.stopPropagation();quickStatus('${escHtml(o.è¨‚å–®ç·¨è™Ÿ)}','å·²å®Œæˆ',${realIdx})">âœ… å®Œæˆ</button>`;
            quickBtns += `<button class="quick-btn q-cancel" onclick="event.stopPropagation();quickStatus('${escHtml(o.è¨‚å–®ç·¨è™Ÿ)}','å–æ¶ˆè¨‚å–®',${realIdx})">âŒ å–æ¶ˆ</button>`;
        }

        return `
        <div class="card" onclick="showOrderDetail(${realIdx})">
            <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <div style="flex:1; min-width:0;">
                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-bottom:6px;">
                        <span class="order-name">${escHtml(o.å§“å || 'æœªçŸ¥')}</span>
                        <span class="badge ${shipClass}">${shipLabel}</span>
                        <span class="badge ${statusBadge}">${status || 'æœªçŸ¥'}</span>
                    </div>
                    <div class="order-meta">
                        ğŸ“± ${escHtml(o.é›»è©± || '-')}ã€€ğŸ• ${escHtml(String(o.è¨‚è³¼æ™‚é–“ || '').substring(0, 16))}<br>
                        ğŸ›’ ${escHtml(String(o.å•†å“æ˜ç´° || '').substring(0, 60))}
                        ${is711 && o.é–€å¸‚åç¨± ? `<br>ğŸª ${escHtml(o.é–€å¸‚åç¨±)}` : ''}
                    </div>
                </div>
                <div class="order-amount">$${escHtml(String(amt))}</div>
            </div>
            <div class="order-quick-actions">${quickBtns}</div>
        </div>`;
    }).join('');

    // åˆ†é 
    if (totalPages > 1) {
        let pag = `<div class="pagination">`;
        if (orderPage > 1) pag += `<button class="page-btn" onclick="goOrderPage(${orderPage - 1})">â€¹ ä¸Šä¸€é </button>`;
        for (let p = Math.max(1, orderPage - 2); p <= Math.min(totalPages, orderPage + 2); p++) {
            pag += `<button class="page-btn ${p === orderPage ? 'active' : ''}" onclick="goOrderPage(${p})">${p}</button>`;
        }
        if (orderPage < totalPages) pag += `<button class="page-btn" onclick="goOrderPage(${orderPage + 1})">ä¸‹ä¸€é  â€º</button>`;
        pag += `</div><div style="text-align:center;color:#555;font-size:12px;margin-top:8px;">å…± ${total} ç­†</div>`;
        el.insertAdjacentHTML('beforeend', pag);
    }
}

function goOrderPage(p) { orderPage = p; renderOrders(); window.scrollTo(0, 0); }

let currentOrderId = null;

function showOrderDetail(idx) {
    const o = filteredOrders[idx];
    currentOrderId = o.è¨‚å–®ç·¨è™Ÿ;

    // æ¬„ä½ä¸­æ–‡å°ç…§
    const labels = {
        è¨‚å–®ç·¨è™Ÿ:'è¨‚å–®ç·¨è™Ÿ', è¨‚è³¼æ™‚é–“:'è¨‚è³¼æ™‚é–“', å§“å:'å§“å', é›»è©±:'é›»è©±',
        å–è²¨æ–¹å¼:'å–è²¨æ–¹å¼', é–€å¸‚åç¨±:'é–€å¸‚', é–€å¸‚åœ°å€:'é–€å¸‚åœ°å€',
        å•†å“æ˜ç´°:'å•†å“æ˜ç´°', å•†å“é‡‘é¡:'å•†å“é‡‘é¡', é‹è²»:'é‹è²»', ç¸½é‡‘é¡:'ç¸½é‡‘é¡',
        è¨‚å–®ç‹€æ…‹:'è¨‚å–®ç‹€æ…‹', ç‰©æµç·¨è™Ÿ:'ç‰©æµç·¨è™Ÿ', åŒ¯æ¬¾æœ«äº”ç¢¼:'åŒ¯æ¬¾æœ«äº”ç¢¼',
        ä»˜æ¬¾æ–¹å¼:'ä»˜æ¬¾æ–¹å¼', é–€å¸‚ä»£ç¢¼:'é–€å¸‚ä»£ç¢¼'
    };
    const rows = Object.entries(labels).map(([k, label]) => {
        if (!o[k] && o[k] !== 0) return '';
        return `<div style="display:flex; gap:12px; padding:9px 0; border-bottom:1px solid rgba(255,255,255,0.05);">
            <div style="width:90px; flex-shrink:0; color:#888; font-size:12px;">${label}</div>
            <div style="flex:1; font-size:13px; word-break:break-all; line-height:1.5;">${escHtml(String(o[k]))}</div>
        </div>`;
    }).join('');

    document.getElementById('orderModalBody').innerHTML = `<div style="padding-bottom:4px;">${rows}</div>`;

    // è¨­å®šç›®å‰ç‹€æ…‹åˆ°ä¸‹æ‹‰é¸å–®
    const sel = document.getElementById('orderStatusSelect');
    sel.value = o.è¨‚å–®ç‹€æ…‹ || 'å¾…ç¢ºèª';

    document.getElementById('orderModal').classList.add('active');
}

async function saveOrderStatus() {
    if (!currentOrderId) return;
    const newStatus = document.getElementById('orderStatusSelect').value;
    const btn = document.getElementById('orderStatusSaveBtn');
    btn.disabled = true;
    btn.textContent = 'å„²å­˜ä¸­...';
    try {
        await scriptPost({ action: 'updateOrderStatus', adminLineId: adminMember.lineId, orderId: currentOrderId, newStatus });
        showToast('âœ… ç‹€æ…‹å·²æ›´æ–°ç‚ºï¼š' + newStatus);
        // æ›´æ–°æœ¬åœ°è³‡æ–™
        const o = allOrders.find(o => o.è¨‚å–®ç·¨è™Ÿ === currentOrderId);
        if (o) o.è¨‚å–®ç‹€æ…‹ = newStatus;
        filterOrders();
        closeOrderModal();
    } catch(e) {
        showToast('âŒ æ›´æ–°å¤±æ•—ï¼š' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ å„²å­˜ç‹€æ…‹';
    }
}

function closeOrderModal() {
    document.getElementById('orderModal').classList.remove('active');
    currentOrderId = null;
}

async function quickStatus(orderId, newStatus, idx) {
    const o = filteredOrders[idx];
    if (!confirm(`å°‡ã€Œ${o.å§“å}ã€çš„è¨‚å–®æ”¹ç‚ºã€Œ${newStatus}ã€ï¼Ÿ`)) return;
    try {
        await scriptPost({ action: 'updateOrderStatus', adminLineId: adminMember.lineId, orderId, newStatus });
        // æ›´æ–°æœ¬åœ°
        const orig = allOrders.find(x => x.è¨‚å–®ç·¨è™Ÿ === orderId);
        if (orig) orig.è¨‚å–®ç‹€æ…‹ = newStatus;
        filterOrders();
        showToast('âœ… å·²æ›´æ–°ï¼š' + newStatus);
    } catch(e) {
        showToast('âŒ æ›´æ–°å¤±æ•—ï¼š' + e.message, 'error');
    }
}

// ==========================================
// ğŸ“¦ åº«å­˜ç®¡ç†
// ==========================================
let allProducts  = [];  // å•†å“åˆ—è¡¨
let allSpecs     = [];  // è¦æ ¼è¡¨ï¼ˆå«åº«å­˜ï¼‰
let filteredProducts = [];
let pendingStockEdits = {};  // { "productId|specName": { row, newStock } }

async function loadStock() {
    document.getElementById('stockList').innerHTML =
        `<div class="loading-state"><div class="icon">â³</div><div>è¼‰å…¥ä¸­...</div></div>`;
    try {
        // åŒæ™‚è®€å•†å“åˆ—è¡¨ + è¦æ ¼è¡¨
        const [prodData, specData] = await Promise.all([
            sheetsRead('å•†å“åˆ—è¡¨'),
            sheetsRead('å•†å“è¦æ ¼è¡¨')
        ]);

        // è§£æå•†å“åˆ—è¡¨ï¼ˆA=id, B=name, C=image, D=isFeatured, E=category, F=tags, G=customBlockï¼‰
        allProducts = (prodData.values || []).slice(1)
            .filter(r => r[0])
            .map((r, i) => ({
                row:         i + 2,
                id:          String(r[0] || ''),
                name:        String(r[1] || ''),
                image:       String(r[2] || ''),
                isFeatured:  String(r[3] || ''),
                category:    String(r[4] || ''),
                tags:        String(r[5] || ''),
                customBlock: String(r[6] || '')
            }));

        // è§£æè¦æ ¼è¡¨ï¼ˆA=å•†å“ç·¨è™Ÿ, B=å•†å“åç¨±, C=æ•¸é‡/è¦æ ¼å, D=ç‰¹åƒ¹, E=åº«å­˜, F=åŸåƒ¹, G=å€æ•¸ï¼‰
        allSpecs = (specData.values || []).slice(1)
            .filter(r => r[0])
            .map((r, i) => ({
                row:       i + 2,
                productId: String(r[0]),
                specName:  String(r[2] || ''),
                salePrice: parseInt(r[3]) || 0,
                stock:     parseInt(r[4]) || 0,
                price:     parseInt(r[5]) || 0,
                multiplier:parseInt(r[6]) || 1
            }));

        filteredProducts = [...allProducts];
        pendingStockEdits = {};
        renderStock();
    } catch(e) {
        document.getElementById('stockList').innerHTML =
            `<div class="loading-state"><div class="icon">âŒ</div><div>è¼‰å…¥å¤±æ•—ï¼š${e.message}</div></div>`;
    }
}

function filterStock() {
    const kw  = document.getElementById('stockSearch').value.trim().toLowerCase();
    const cat = document.getElementById('stockCatFilter').value;
    filteredProducts = allProducts.filter(p =>
        (!kw  || p.name.toLowerCase().includes(kw) || p.id.toLowerCase().includes(kw) || p.category.toLowerCase().includes(kw)) &&
        (!cat || p.category === cat)
    );
    renderStock();
}

function buildCatFilter() {
    const cats = [...new Set(allProducts.map(p => p.category).filter(Boolean))].sort();
    const sel = document.getElementById('stockCatFilter');
    const cur = sel.value;
    sel.innerHTML = '<option value="">å…¨éƒ¨é¡åˆ¥</option>';
    cats.forEach(c => {
        const o = document.createElement('option');
        o.value = c; o.textContent = c;
        if (c === cur) o.selected = true;
        sel.appendChild(o);
    });
}

let inlineEditId = null;  // ç›®å‰å°±åœ°ç·¨è¼¯çš„å•†å“ id

function renderStock() {
    buildCatFilter();
    const el = document.getElementById('stockList');
    if (filteredProducts.length === 0) {
        el.innerHTML = `<div class="loading-state"><div class="icon">ğŸ“¦</div><div>æ²’æœ‰ç¬¦åˆçš„å•†å“</div></div>`;
        return;
    }

    const rows = filteredProducts.map(p => {
        const specs   = allSpecs.filter(s => s.productId === p.id);
        const bao     = specs.find(s => s.specName === 'å–®åŒ…');
        const tiao    = specs.find(s => s.specName === 'æ¢');
        const tai     = specs.find(s => s.specName === 'å°');
        const isEditing = inlineEditId === p.id;

        const imgCell = p.image
            ? `<img class="stock-td-img" src="${escHtml(p.image)}" onerror="this.style.display='none'">`
            : `<div class="stock-td-img-empty">ğŸ“¦</div>`;

        function stockCls(s) { return s===0?'zero':s<=10?'low':'ok'; }

        function specCell(spec) {
            if (!spec) return `<td colspan="2" style="color:#333;text-align:center;">â€”</td>`;
            const isTiao = spec.specName === 'æ¢';
            if (isEditing) {
                const stockField = isTiao
                    ? `<span class="stock-sync">ğŸ”—åŒåŒ…</span>`
                    : `<input class="tbl-input" type="number" min="0" id="ie_stock_${p.id}_${spec.specName}" value="${spec.stock}">`;
                return `
                <td>${stockField}</td>
                <td>
                    <div style="display:flex;flex-direction:column;gap:4px;">
                        <input class="tbl-input" type="number" min="0" placeholder="åŸåƒ¹" id="ie_price_${p.id}_${spec.specName}" value="${spec.price}">
                        <input class="tbl-input" type="number" min="0" placeholder="ç‰¹åƒ¹" id="ie_sale_${p.id}_${spec.specName}" value="${spec.salePrice||''}">
                    </div>
                </td>`;
            }
            const priceStr = spec.salePrice
                ? `<div class="stock-sale">ç‰¹ $${spec.salePrice}</div><div class="stock-price" style="text-decoration:line-through;font-size:11px;">$${spec.price}</div>`
                : `<div class="stock-price">$${spec.price}</div>`;
            return `
            <td><span class="stock-num ${stockCls(spec.stock)}">${spec.stock}</span>${isTiao?'<div class="stock-sync">ğŸ”—åŒåŒ…</div>':''}</td>
            <td>${priceStr}</td>`;
        }

        const actionCell = isEditing ? `
            <td class="tbl-actions">
                <button class="btn btn-green btn-sm" onclick="saveInlineEdit('${escHtml(p.id)}')">ğŸ’¾</button>
                <button class="btn btn-sm" onclick="cancelInlineEdit()" style="background:rgba(255,255,255,0.05);border-color:#444;color:#999;">âœ•</button>
            </td>` : `
            <td class="tbl-actions">
                <button class="btn btn-yellow btn-sm" onclick="startInlineEdit('${escHtml(p.id)}')">âœï¸</button>
            </td>`;

        // â”€â”€ å°±åœ°ç·¨è¼¯ï¼šå•†å“åŸºæœ¬è³‡æ–™æ¬„ â”€â”€
        let idCell, imgEditCell, nameCell, categoryCell, tagsCell, blockCell, featuredCell;
        if (isEditing) {
            // æ”¶é›†ç¾æœ‰é¸é …
            const allCats   = [...new Set(allProducts.map(x=>x.category).filter(Boolean))];
            const allTags   = [...new Set(allProducts.flatMap(x=>x.tags.split(',').map(t=>t.trim())).filter(Boolean))];
            const allBlocks = [...new Set(allProducts.map(x=>x.customBlock).filter(Boolean))];

            function makeCombo(pid, field, opts, curVal, placeholder, wide) {
                const selId = `ie_${field}_sel_${pid}`;
                const inpId = `ie_${field}_${pid}`;
                const inSel = opts.includes(curVal);
                const selVal = inSel ? curVal : (curVal ? '__custom__' : '');
                const inpDisplay = (!inSel && curVal) ? 'block' : 'none';
                const w = wide ? 'tbl-input-wide' : 'tbl-input';
                let optsHtml = `<option value="">${placeholder}</option>`;
                opts.forEach(o => { optsHtml += `<option value="${escHtml(o)}" ${o===curVal?'selected':''}>${escHtml(o)}</option>`; });
                optsHtml += `<option value="__custom__" ${!inSel&&curVal?'selected':''}>âœï¸ è‡ªè¨‚ç¾©...</option>`;
                return `<div style="display:flex;flex-direction:column;gap:3px;">
                    <select class="tbl-input ${w}" id="${selId}" onchange="ieComboChange('${pid}','${field}')">
                        ${optsHtml}
                    </select>
                    <input class="tbl-input ${w}" id="${inpId}" value="${escHtml(!inSel?curVal:'')}" placeholder="è¼¸å…¥è‡ªè¨‚..." style="display:${inpDisplay};">
                </div>`;
            }

            idCell       = `<td style="white-space:nowrap;color:#888;font-size:12px;">${escHtml(p.id)}</td>`;
            imgEditCell  = `<td><input class="tbl-input tbl-input-wide" id="ie_image_${p.id}" placeholder="åœ–ç‰‡æˆ–Driveé€£çµ" value="${escHtml(p.image)}" oninput="autoConvertDriveUrl('ie_image_${p.id}')"></td>`;
            nameCell     = `<td><input class="tbl-input tbl-input-wide" id="ie_name_${p.id}" value="${escHtml(p.name)}"></td>`;
            categoryCell = `<td>${makeCombo(p.id,'cat',allCats,p.category,'â”€â”€ é¡åˆ¥ â”€â”€',false)}</td>`;
            tagsCell     = `<td>${makeCombo(p.id,'tags',allTags,p.tags,'â”€â”€ æ¨™ç±¤ â”€â”€',true)}</td>`;
            blockCell    = `<td>${makeCombo(p.id,'block',allBlocks,p.customBlock,'â”€â”€ å€å¡Š â”€â”€',false)}</td>`;
            featuredCell = `<td style="text-align:center;"><input type="checkbox" id="ie_feat_${p.id}" ${p.isFeatured==='æ˜¯'?'checked':''} style="width:16px;height:16px;accent-color:#FFD700;"></td>`;
        } else {
            const featuredBadge = p.isFeatured === 'æ˜¯' ? `<span class="badge badge-yellow" style="font-size:10px;">ä¸»æ‰“</span>` : '';
            const blockBadge    = p.customBlock ? `<span class="badge badge-purple" style="font-size:10px;">${escHtml(p.customBlock)}</span>` : 'â€”';
            idCell       = `<td style="white-space:nowrap;color:#888;font-size:12px;">${escHtml(p.id)}</td>`;
            imgEditCell  = `<td>${imgCell}</td>`;
            nameCell     = `<td><div style="font-weight:900;">${escHtml(p.name)}</div></td>`;
            categoryCell = `<td><span style="color:#a78bfa;font-size:12px;">${escHtml(p.category||'â€”')}</span></td>`;
            tagsCell     = `<td style="font-size:11px;color:#666;">${escHtml(p.tags||'â€”')}</td>`;
            blockCell    = `<td style="font-size:12px;">${blockBadge}</td>`;
            featuredCell = `<td style="text-align:center;">${featuredBadge}</td>`;
        }

        return `<tr class="${isEditing?'editing':''}">
            ${idCell}
            ${imgEditCell}
            ${nameCell}
            ${categoryCell}
            ${tagsCell}
            ${blockCell}
            ${featuredCell}
            ${specCell(bao)}
            ${specCell(tiao)}
            ${specCell(tai)}
            ${actionCell}
        </tr>`;
    }).join('');

    el.innerHTML = `
    <div class="stock-table-wrap">
        <table class="stock-table">
            <thead>
                <tr>
                    <th>ç·¨è™Ÿ</th>
                    <th>åœ–ç‰‡</th>
                    <th>å•†å“åç¨±</th>
                    <th>é¡åˆ¥</th>
                    <th>åˆ†é¡æ¨™ç±¤</th>
                    <th>è‡ªå®šç¾©å€å¡Š</th>
                    <th>ä¸»æ‰“</th>
                    <th>å–®åŒ…åº«å­˜</th><th>å–®åŒ…åƒ¹æ ¼</th>
                    <th>æ¢åº«å­˜</th><th>æ¢åƒ¹æ ¼</th>
                    <th>å°åº«å­˜</th><th>å°åƒ¹æ ¼</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    </div>`;
}

function startInlineEdit(productId) {
    inlineEditId = productId;
    renderStock();
    // scroll to row
    setTimeout(() => {
        const row = document.querySelector('.stock-table tr.editing');
        if (row) row.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 50);
}

function cancelInlineEdit() {
    inlineEditId = null;
    renderStock();
}

function ieComboChange(pid, field) {
    const selId = `ie_${field}_sel_${pid}`;
    const inpId = `ie_${field}_${pid}`;
    const sel = document.getElementById(selId);
    const inp = document.getElementById(inpId);
    if (!sel || !inp) return;
    if (sel.value === '__custom__') {
        inp.style.display = 'block';
        inp.focus();
        inp.value = '';
    } else {
        inp.style.display = 'none';
        inp.value = '';
    }
    // å¦‚æœæ”¹çš„æ˜¯é¡åˆ¥ï¼Œè‡ªå‹•å¸¶å…¥å°æ‡‰æ¨™ç±¤
    if (field === 'cat') ieAutofillTags(pid);
}

function ieAutofillTags(pid) {
    const catSel  = document.getElementById(`ie_cat_sel_${pid}`);
    const tagsSel = document.getElementById(`ie_tags_sel_${pid}`);
    const tagsInp = document.getElementById(`ie_tags_${pid}`);
    if (!catSel || !tagsSel) return;

    const selectedCat = catSel.value;
    if (!selectedCat || selectedCat === '__custom__') {
        tagsSel.disabled = false;
        return;
    }

    const match = allProducts.find(p => p.category === selectedCat && p.tags);
    if (match) {
        const matchedTag = match.tags.split(',')[0].trim();
        const opt = [...tagsSel.options].find(o => o.value === matchedTag);
        if (opt) {
            tagsSel.value = matchedTag;
            if (tagsInp) tagsInp.style.display = 'none';
        }
        tagsSel.disabled = true;
    } else {
        tagsSel.disabled = false;
    }
}

function ieGetComboVal(pid, field) {
    const selId = `ie_${field}_sel_${pid}`;
    const inpId = `ie_${field}_${pid}`;
    const sel = document.getElementById(selId);
    const inp = document.getElementById(inpId);
    if (!sel) return document.getElementById(inpId)?.value.trim() || '';
    if (sel.value === '__custom__') return inp?.value.trim() || '';
    return sel.value || '';
}

async function saveInlineEdit(productId) {
    const p = allProducts.find(x => x.id === productId);
    if (!p) return;
    const specs = allSpecs.filter(s => s.productId === productId);

    // æ”¶é›†åº«å­˜æ›´æ–°
    const stockUpdates = [];
    specs.forEach(s => {
        if (s.specName === 'æ¢') return;  // æ¢åŒæ­¥å–®åŒ…
        const el = document.getElementById(`ie_stock_${productId}_${s.specName}`);
        if (el) {
            const newStock = parseInt(el.value) || 0;
            if (newStock !== s.stock) stockUpdates.push({ row: s.row, newStock });
        }
    });

    // æ¢åŒæ­¥å–®åŒ…
    const bao = specs.find(s => s.specName === 'å–®åŒ…');
    const tiao = specs.find(s => s.specName === 'æ¢');
    if (bao && tiao) {
        const baoEl = document.getElementById(`ie_stock_${productId}_å–®åŒ…`);
        const baoNewStock = baoEl ? (parseInt(baoEl.value)||0) : bao.stock;
        if (baoNewStock !== tiao.stock) stockUpdates.push({ row: tiao.row, newStock: baoNewStock });
    }

    // æ”¶é›†åƒ¹æ ¼æ›´æ–°
    const specUpdates = specs.map(s => {
        const priceEl = document.getElementById(`ie_price_${productId}_${s.specName}`);
        const saleEl  = document.getElementById(`ie_sale_${productId}_${s.specName}`);
        return {
            row:       s.row,
            price:     parseInt(priceEl?.value) || s.price,
            salePrice: parseInt(saleEl?.value)  || 0
        };
    });

    // è®€å–åŸºæœ¬è³‡æ–™æ¬„çš„æ–°å€¼
    const newName     = document.getElementById(`ie_name_${productId}`)?.value.trim()  || p.name;
    const newImage    = document.getElementById(`ie_image_${productId}`)?.value.trim() || p.image;
    const newCat      = ieGetComboVal(productId, 'cat');
    const newTags     = ieGetComboVal(productId, 'tags');
    const newBlock    = ieGetComboVal(productId, 'block');
    const newFeatured = document.getElementById(`ie_feat_${productId}`)?.checked ? 'æ˜¯' : '';

    try {
        const promises = [];
        if (stockUpdates.length > 0) {
            promises.push(scriptPost({ action:'updateStock', adminLineId:adminMember.lineId, updates:stockUpdates }));
        }
        promises.push(scriptPost({
            action:'adminEditProduct', adminLineId:adminMember.lineId,
            product:{ row:p.row, id:p.id, name:newName, image:newImage, isFeatured:newFeatured, category:newCat, tags:newTags, customBlock:newBlock },
            specUpdates, newSpecs:[]
        }));
        await Promise.all(promises);

        // æ›´æ–°æœ¬åœ°è³‡æ–™
        Object.assign(p, { name:newName, image:newImage, isFeatured:newFeatured, category:newCat, tags:newTags, customBlock:newBlock });
        specs.forEach(s => {
            if (s.specName !== 'æ¢') {
                const el = document.getElementById(`ie_stock_${productId}_${s.specName}`);
                if (el) s.stock = parseInt(el.value)||0;
            }
            if (bao && tiao) {
                const baoEl = document.getElementById(`ie_stock_${productId}_å–®åŒ…`);
                tiao.stock = baoEl ? (parseInt(baoEl.value)||0) : bao.stock;
            }
            const priceEl = document.getElementById(`ie_price_${productId}_${s.specName}`);
            const saleEl  = document.getElementById(`ie_sale_${productId}_${s.specName}`);
            if (priceEl) s.price = parseInt(priceEl.value)||0;
            if (saleEl)  s.salePrice = parseInt(saleEl.value)||0;
        });

        showToast(`âœ… ${newName} å·²å„²å­˜`);
        inlineEditId = null;
        renderStock();
        syncCategoryTags(newTags);  // åŒæ­¥æ–°åˆ†é¡æ¨™ç±¤åˆ°åˆ†é¡è¨­å®š
    } catch(e) {
        showToast('âŒ å„²å­˜å¤±æ•—ï¼š' + e.message, 'error');
    }
}

let editingStock = null;

function openStockModal(productId, productName, specName, currentStock, row) {
    editingStock = { productId, productName, specName, currentStock, row };
    document.getElementById('stockModalTitle').textContent = `âœï¸ ä¿®æ”¹åº«å­˜ï¼š${productName}`;
    document.getElementById('stockModalBody').innerHTML = `
        <div style="margin-bottom:16px;">
            <div style="font-size:14px; color:#888; margin-bottom:6px;">è¦æ ¼ï¼š<strong style="color:#fff;">${escHtml(specName)}</strong></div>
            <div style="font-size:14px; color:#888; margin-bottom:16px;">ç›®å‰åº«å­˜ï¼š<strong style="color:#00FF00; font-size:22px;">${currentStock}</strong></div>
            <label class="form-label">æ–°åº«å­˜æ•¸é‡</label>
            <input class="form-input" id="stockNewVal" type="number" min="0" value="${currentStock}" style="font-size:18px; text-align:center;">
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn btn-sm" onclick="adjustStock(-10)" style="background:rgba(255,68,68,.1);border-color:#ff4444;color:#ff4444;">-10</button>
            <button class="btn btn-sm" onclick="adjustStock(-1)"  style="background:rgba(255,68,68,.1);border-color:#ff4444;color:#ff4444;">-1</button>
            <button class="btn btn-sm" onclick="adjustStock(1)"   style="background:rgba(0,255,0,.1);border-color:#00FF00;color:#00FF00;">+1</button>
            <button class="btn btn-sm" onclick="adjustStock(10)"  style="background:rgba(0,255,0,.1);border-color:#00FF00;color:#00FF00;">+10</button>
            <button class="btn btn-sm" onclick="adjustStock(50)"  style="background:rgba(0,255,0,.1);border-color:#00FF00;color:#00FF00;">+50</button>
        </div>`;
    document.getElementById('stockModal').classList.add('active');
    setTimeout(() => document.getElementById('stockNewVal').focus(), 100);
}

function adjustStock(delta) {
    const input = document.getElementById('stockNewVal');
    const val = Math.max(0, (parseInt(input.value) || 0) + delta);
    input.value = val;
}

async function saveStock() {
    if (!editingStock) return;
    const newStock = parseInt(document.getElementById('stockNewVal').value);
    if (isNaN(newStock) || newStock < 0) { showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„åº«å­˜æ•¸é‡', 'error'); return; }

    const btn = document.getElementById('stockSaveBtn');
    btn.disabled = true;
    btn.textContent = 'å„²å­˜ä¸­...';

    try {
        // æ‰¾å‡ºåŒå•†å“çš„ã€Œæ¢ã€è¦æ ¼ï¼ˆè‹¥å­˜åœ¨ï¼ŒåŒæ­¥æ›´æ–°ï¼‰
        const tiaoSpec = allSpecs.find(s => s.productId === editingStock.productId && s.specName === 'æ¢');
        const updates = [{ row: editingStock.row, newStock }];
        if (editingStock.specName === 'å–®åŒ…' && tiaoSpec) {
            updates.push({ row: tiaoSpec.row, newStock });
        }
        await scriptPost({
            action: 'updateStock',
            adminLineId: adminMember.lineId,
            updates
        });
        // æ›´æ–°æœ¬åœ°è³‡æ–™
        const spec = allSpecs.find(s => s.row === editingStock.row);
        if (spec) spec.stock = newStock;
        if (editingStock.specName === 'å–®åŒ…' && tiaoSpec) tiaoSpec.stock = newStock;
        const syncMsg = (editingStock.specName === 'å–®åŒ…' && tiaoSpec) ? 'ï¼ˆæ¢å·²åŒæ­¥ï¼‰' : '';
        showToast(`âœ… ${editingStock.productName}-${editingStock.specName} åº«å­˜å·²æ›´æ–°ç‚º ${newStock} ${syncMsg}`);
        closeStockModal();
        renderStock();
    } catch(e) {
        showToast('âŒ æ›´æ–°å¤±æ•—ï¼š' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ å„²å­˜';
    }
}

function closeStockModal() {
    document.getElementById('stockModal').classList.remove('active');
    editingStock = null;
}
// ==========================================
// âœï¸ ç·¨è¼¯å•†å“
// ==========================================
let editingProduct = null;

function autoConvertDriveUrl(inputId) {
    const input = document.getElementById(inputId);
    const val = input.value.trim();

    let converted = false;

    // æ ¼å¼1ï¼šhttps://drive.google.com/file/d/FILE_ID/view
    // æ ¼å¼2ï¼šhttps://drive.google.com/open?id=FILE_ID
    // æ ¼å¼3ï¼šhttps://drive.google.com/uc?id=FILE_IDï¼ˆå·²æ¥è¿‘ç›´é€£ï¼Œè£œ export=viewï¼‰
    const driveMatch = val.match(/drive\.google\.com(?:\/file\/d\/|.*[?&]id=)([a-zA-Z0-9_-]{20,})/);
    if (driveMatch) {
        const fileId = driveMatch[1];
        input.value = `https://lh3.googleusercontent.com/d/${fileId}`;
        input.style.borderColor = '#00FF00';
        setTimeout(() => input.style.borderColor = '', 2000);
        converted = true;
    }

    // æ ¼å¼4ï¼šå·²æ˜¯ lh3.googleusercontent.com/d/FILE_ID ç›´é€£ â†’ ç›´æ¥å¯ç”¨ï¼Œä¸è½‰æ›
    // æ ¼å¼5ï¼šå·²æ˜¯ drive.google.com/uc?export=view&id=FILE_ID â†’ ä¹Ÿå¯ç”¨ï¼Œä¸è½‰æ›

    // é è¦½åœ–ç‰‡
    const previewDiv = document.getElementById(inputId + '_preview');
    const thumb = document.getElementById(inputId + '_thumb');
    const url = input.value.trim();
    if (previewDiv && thumb && url.startsWith('http')) {
        thumb.src = url;
        thumb.onload = () => { previewDiv.style.display = 'block'; };
        thumb.onerror = () => { previewDiv.style.display = 'none'; };
    } else if (previewDiv) {
        previewDiv.style.display = 'none';
    }
}

async function openEditProductModal(productId) {
    const p = allProducts.find(x => x.id === productId);
    if (!p) return;
    editingProduct = { ...p };

    document.getElementById('ep_id').value   = p.id;
    document.getElementById('ep_name').value = p.name;
    document.getElementById('ep_image').value = p.image;
    document.getElementById('ep_featured').checked = p.isFeatured === 'æ˜¯';

    // é è¦½åœ–ç‰‡
    autoConvertDriveUrl('ep_image');

    // è¼‰å…¥ä¸‹æ‹‰ä¸¦è¨­å®šç•¶å‰å€¼
    await loadComboOptionsForEdit();
    setComboValue('ep_category_sel','ep_category','ep_category_c', p.category);
    setComboValue('ep_tags_sel',    'ep_tags',    'ep_tags_c',     p.tags);
    setComboValue('ep_block_sel',   'ep_block',   'ep_block_c',    p.customBlock);

    // è¦æ ¼åƒ¹æ ¼åˆ—è¡¨
    const specs = allSpecs.filter(s => s.productId === productId);
    const existingSpecNames = specs.map(s => s.specName);
    const allSpecTypes = ['å–®åŒ…','æ¢','å°'];
    const hasBao  = existingSpecNames.includes('å–®åŒ…');
    const hasTiao = existingSpecNames.includes('æ¢');
    const hasTai  = existingSpecNames.includes('å°');
    // åŒ…â†”æ¢äº’è£œï¼šåªæœ‰åŒ…æ‰èƒ½æ–°å¢æ¢ï¼Œåªæœ‰æ¢æ‰èƒ½æ–°å¢åŒ…
    // å°ç¨ç«‹
    const missingSpecs = allSpecTypes.filter(n => {
        if (existingSpecNames.includes(n)) return false;
        if (n === 'æ¢') return hasBao && !hasTiao;   // æœ‰åŒ…æ‰èƒ½åŠ æ¢
        if (n === 'å–®åŒ…') return hasTiao && !hasBao; // æœ‰æ¢æ‰èƒ½åŠ åŒ…
        if (n === 'å°') return !hasTai;               // å°ç¨ç«‹
        return false;
    });

    const existingHtml = specs.map(s => `
        <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:10px;align-items:center;padding:10px;background:rgba(255,255,255,0.03);border-radius:10px;margin-bottom:8px;">
            <div style="font-weight:900;color:${s.specName==='æ¢'?'#a78bfa':s.specName==='å°'?'#34d399':'#FFD700'};">${escHtml(s.specName)}</div>
            <div class="form-group" style="margin:0;">
                <label class="form-label">åŸåƒ¹ï¼ˆå…ƒï¼‰</label>
                <input class="form-input" id="ep_price_${escHtml(s.specName)}" type="number" min="0" value="${s.price}" data-spec-row="${s.row}">
            </div>
            <div class="form-group" style="margin:0;">
                <label class="form-label">ç‰¹åƒ¹ <span style="color:#555;">ï¼ˆç©ºç™½=ç„¡ç‰¹åƒ¹ï¼‰</span></label>
                <input class="form-input" id="ep_sale_${escHtml(s.specName)}" type="number" min="0" value="${s.salePrice || ''}" placeholder="ç„¡ç‰¹åƒ¹">
            </div>
        </div>
    `).join('');

    const addSpecHtml = missingSpecs.length === 0 ? '' : `
        <div style="border-top:1px solid rgba(255,255,255,0.08);margin-top:12px;padding-top:12px;">
            <div style="font-size:11px;font-weight:900;color:#888;letter-spacing:1px;margin-bottom:10px;">â• æ–°å¢è¦æ ¼</div>
            ${missingSpecs.map(n => `
            <div id="ep_add_block_${n}" style="background:rgba(255,255,255,0.02);border:1.5px dashed rgba(255,255,255,0.1);border-radius:10px;padding:10px;margin-bottom:8px;">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:8px;">
                    <input type="checkbox" id="ep_add_chk_${n}" style="width:15px;height:15px;accent-color:#FFD700;"
                        onchange="toggleNewSpecFields('${n}')">
                    <span style="font-weight:900;color:${n==='æ¢'?'#a78bfa':n==='å°'?'#34d399':'#FFD700'};">${n}</span>
                    ${n==='æ¢'?'<span style="font-size:11px;color:#555;">ï¼ˆåº«å­˜åŒæ­¥å–®åŒ…ï¼‰</span>':''}
                </label>
                <div id="ep_add_fields_${n}" style="display:none;grid-template-columns:1fr 1fr;gap:10px;">
                    <div class="form-group" style="margin:0;">
                        <label class="form-label">åŸåƒ¹ï¼ˆå…ƒï¼‰*</label>
                        <input class="form-input" id="ep_add_price_${n}" type="number" min="0" placeholder="ä¾‹ï¼š${n==='å°'?'4500':'450'}">
                    </div>
                    <div class="form-group" style="margin:0;">
                        <label class="form-label">ç‰¹åƒ¹ <span style="color:#555;">ï¼ˆé¸å¡«ï¼‰</span></label>
                        <input class="form-input" id="ep_add_sale_${n}" type="number" min="0" placeholder="ç„¡ç‰¹åƒ¹">
                    </div>
                </div>
            </div>`).join('')}
        </div>`;

    document.getElementById('ep_specs_list').innerHTML = existingHtml + addSpecHtml;

    document.getElementById('editProductModal').classList.add('active');
}

async function loadComboOptionsForEdit() {
    if (allProducts.length === 0 || !('category' in allProducts[0])) return;
    const cats   = [...new Set(allProducts.map(p => p.category).filter(Boolean))];
    const tags   = [...new Set(allProducts.flatMap(p => p.tags.split(',').map(t=>t.trim())).filter(Boolean))];
    const blocks = [...new Set(allProducts.map(p => p.customBlock).filter(Boolean))];

    function buildSel(selId, items, placeholder) {
        const sel = document.getElementById(selId);
        sel.innerHTML = `<option value="">${placeholder}</option>`;
        items.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v; opt.textContent = v; sel.appendChild(opt);
        });
        const custom = document.createElement('option');
        custom.value = '__custom__'; custom.textContent = 'âœï¸ è‡ªè¨‚ç¾©...';
        sel.appendChild(custom);
    }
    buildSel('ep_category_sel', cats,   'â”€â”€ è«‹é¸æ“‡é¡åˆ¥ â”€â”€');
    buildSel('ep_tags_sel',     tags,   'â”€â”€ è«‹é¸æ“‡æ¨™ç±¤ â”€â”€');
    buildSel('ep_block_sel',    blocks, 'â”€â”€ ç©ºç™½ï¼ˆä¸è¨­å®šï¼‰â”€â”€');
}

function setComboValue(selId, inputId, hiddenId, value) {
    const sel = document.getElementById(selId);
    // æª¢æŸ¥æ˜¯å¦åœ¨é¸é …ä¸­
    const exists = [...sel.options].some(o => o.value === value);
    if (value && exists) {
        sel.value = value;
        document.getElementById(inputId).style.display = 'none';
    } else if (value) {
        // è‡ªè¨‚ç¾©
        sel.value = '__custom__';
        document.getElementById(inputId).style.display = 'block';
        document.getElementById(inputId).value = value;
    } else {
        sel.value = '';
        document.getElementById(inputId).style.display = 'none';
    }
    document.getElementById(hiddenId).value = value;
}

async function saveEditProduct() {
    if (!editingProduct) return;
    const name = document.getElementById('ep_name').value.trim();
    if (!name) { showToast('è«‹å¡«å…¥å•†å“åç¨±', 'error'); return; }

    const btn = document.getElementById('editProductSaveBtn');
    btn.disabled = true;
    btn.textContent = 'å„²å­˜ä¸­...';

    const productRow = {
        row:         editingProduct.row,
        id:          editingProduct.id,
        name,
        image:       document.getElementById('ep_image').value.trim(),
        isFeatured:  document.getElementById('ep_featured').checked ? 'æ˜¯' : '',
        category:    getComboValue('ep_category_sel','ep_category'),
        tags:        getComboValue('ep_tags_sel','ep_tags'),
        customBlock: getComboValue('ep_block_sel','ep_block')
    };

    // è¦æ ¼åƒ¹æ ¼ï¼ˆç¾æœ‰è¦æ ¼ï¼‰
    const specs = allSpecs.filter(s => s.productId === editingProduct.id);
    const specUpdates = specs.map(s => {
        const priceEl = document.getElementById('ep_price_' + s.specName);
        const saleEl  = document.getElementById('ep_sale_'  + s.specName);
        return {
            row:       s.row,
            price:     parseInt(priceEl?.value) || 0,
            salePrice: parseInt(saleEl?.value)  || 0
        };
    });

    // æ–°å¢è¦æ ¼ï¼ˆå‹¾é¸çš„ï¼‰
    const allSpecTypes = ['å–®åŒ…','æ¢','å°'];
    const existingSpecNames = specs.map(s => s.specName);
    const baoSpec = specs.find(s => s.specName === 'å–®åŒ…');
    const baoStock = baoSpec ? baoSpec.stock : 0;
    const newSpecs = allSpecTypes
        .filter(n => !existingSpecNames.includes(n))
        .filter(n => document.getElementById('ep_add_chk_' + n)?.checked)
        .map(n => {
            const price    = parseInt(document.getElementById('ep_add_price_' + n)?.value) || 0;
            const salePrice= parseInt(document.getElementById('ep_add_sale_'  + n)?.value) || 0;
            const stock    = n === 'æ¢' ? baoStock : 0;
            const multiplier = n === 'æ¢' ? 10 : 1;
            return { specName: n, price, salePrice, stock, multiplier };
        });

    try {
        await scriptPost({
            action:      'adminEditProduct',
            adminLineId: adminMember.lineId,
            product:     productRow,
            specUpdates,
            newSpecs
        });

        // æ›´æ–°æœ¬åœ°è³‡æ–™
        const p = allProducts.find(x => x.id === editingProduct.id);
        if (p) Object.assign(p, { name: productRow.name, image: productRow.image, isFeatured: productRow.isFeatured, category: productRow.category, tags: productRow.tags, customBlock: productRow.customBlock });
        specs.forEach(s => {
            const priceEl = document.getElementById('ep_price_' + s.specName);
            const saleEl  = document.getElementById('ep_sale_'  + s.specName);
            if (priceEl) s.price = parseInt(priceEl.value) || 0;
            if (saleEl)  s.salePrice = parseInt(saleEl.value) || 0;
        });

        showToast(`âœ… å•†å“ã€Œ${name}ã€å·²æ›´æ–°ï¼`);
        closeEditProductModal();
        renderStock();
        syncCategoryTags(productRow.tags);  // åŒæ­¥æ–°åˆ†é¡æ¨™ç±¤
    } catch(e) {
        showToast('âŒ æ›´æ–°å¤±æ•—ï¼š' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ å„²å­˜å•†å“';
    }
}

function closeEditProductModal() {
    document.getElementById('editProductModal').classList.remove('active');
    editingProduct = null;
}

// â”€â”€â”€ åˆ†é¡æ¨™ç±¤åŒæ­¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let knownTags = [];  // å¾ allProducts è’é›†çš„å·²çŸ¥æ¨™ç±¤

function refreshKnownTags() {
    knownTags = [...new Set(
        allProducts.flatMap(p => (p.tags || '').split(',').map(t => t.trim())).filter(Boolean)
    )];
}

function getNewTags(tagsStr) {
    // å›å‚³æ­¤æ¬¡å¡«å…¥ä½† knownTags è£¡æ²’æœ‰çš„æ¨™ç±¤
    if (!tagsStr) return [];
    refreshKnownTags();
    return tagsStr.split(',').map(t => t.trim()).filter(t => t && !knownTags.includes(t));
}



function toggleNewSpecFields(specName) {
    const checked = document.getElementById('ep_add_chk_' + specName).checked;
    const fields  = document.getElementById('ep_add_fields_' + specName);
    fields.style.display = checked ? 'grid' : 'none';
}



// ==========================================
// ï¼‹ æ–°å¢å•†å“
// ==========================================

function openAddProductModal() {
    // æ¸…ç©ºåŸºæœ¬æ¬„ä½
    ['np_id','np_name','np_image'].forEach(id => {
        document.getElementById(id).value = '';
    });
    document.getElementById('np_featured').checked = false;

    // é‡ç½® combo æ¬„ä½ï¼ˆä¸‹æ‹‰ + è‡ªè¨‚è¼¸å…¥ï¼‰
    ['np_category','np_tags','np_block'].forEach(fld => {
        document.getElementById(fld).value = '';
        document.getElementById(fld).style.display = 'none';
        document.getElementById(fld + '_sel').value = '';
        document.getElementById(fld + '_custom').value = '';
    });

    // è¦æ ¼ï¼šå–®åŒ…é è¨­å‹¾é¸ï¼Œæ¢/å°é è¨­ä¸å‹¾
    ['å–®åŒ…','æ¢','å°'].forEach(spec => {
        const chk = document.getElementById('spec_check_' + spec);
        const fields = document.getElementById('spec_fields_' + spec);
        chk.checked = spec === 'å–®åŒ…';
        fields.style.display = spec === 'å–®åŒ…' ? 'grid' : 'none';
        ['spec_price_','spec_sale_'].forEach(pre => {
            const el = document.getElementById(pre + spec);
            if (el) el.value = '';
        });
        const stockEl = document.getElementById('spec_stock_' + spec);
        if (stockEl) stockEl.value = '0';
    });

    document.getElementById('addProductModal').classList.add('active');
    genProductId();
    loadComboOptions();
}

function closeAddProductModal() {
    document.getElementById('addProductModal').classList.remove('active');
}

function toggleSpecBlock(specName) {
    const checked = document.getElementById('spec_check_' + specName).checked;
    const fields  = document.getElementById('spec_fields_' + specName);
    fields.style.display = checked ? 'grid' : 'none';
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Combo ä¸‹æ‹‰é¸å–®ï¼ˆé¡åˆ¥ / æ¨™ç±¤ / è‡ªå®šç¾©å€å¡Šï¼‰
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadComboOptions() {
    // ç¢ºä¿ allProducts å·²å«å®Œæ•´æ¬„ä½
    if (allProducts.length === 0 || !('category' in allProducts[0])) {
        try {
            const prodData = await sheetsRead('å•†å“åˆ—è¡¨');
            allProducts = (prodData.values || []).slice(1)
                .filter(r => r[0])
                .map(r => ({
                    id: String(r[0]), name: String(r[1]||''),
                    category: String(r[4]||''), tags: String(r[5]||''),
                    customBlock: String(r[6]||'')
                }));
        } catch(e) { return; }
    }

    // è’é›†å”¯ä¸€å€¼
    const cats   = [...new Set(allProducts.map(p => p.category).filter(Boolean))];
    const tags   = [...new Set(allProducts.flatMap(p => p.tags.split(',').map(t=>t.trim())).filter(Boolean))];
    const blocks = [...new Set(allProducts.map(p => p.customBlock).filter(Boolean))];

    function buildSel(selId, items, placeholder) {
        const sel = document.getElementById(selId);
        sel.innerHTML = `<option value="">${placeholder}</option>`;
        items.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v; opt.textContent = v;
            sel.appendChild(opt);
        });
        const custom = document.createElement('option');
        custom.value = '__custom__'; custom.textContent = 'âœï¸ è‡ªè¨‚ç¾©...';
        sel.appendChild(custom);
    }

    buildSel('np_category_sel', cats,   'â”€â”€ è«‹é¸æ“‡é¡åˆ¥ â”€â”€');
    buildSel('np_tags_sel',     tags,   'â”€â”€ è«‹é¸æ“‡æ¨™ç±¤ â”€â”€');
    buildSel('np_block_sel',    blocks, 'â”€â”€ ç©ºç™½ï¼ˆä¸è¨­å®šï¼‰â”€â”€');
}

function handleComboChange(selId, inputId, hiddenId) {
    const sel = document.getElementById(selId);
    const input = document.getElementById(inputId);
    if (sel.value === '__custom__') {
        input.style.display = 'block';
        input.value = '';
        input.focus();
        document.getElementById(hiddenId).value = '__custom__';
    } else {
        input.style.display = 'none';
        document.getElementById(hiddenId).value = sel.value;
    }
}

// é¸äº†é¡åˆ¥å¾Œï¼Œè‡ªå‹•å¸¶å…¥å°æ‡‰çš„åˆ†é¡æ¨™ç±¤ä¸¦é–å®šä¸çµ¦æ”¹
function autofillTagsByCategory(prefix) {
    const catSelId  = prefix + '_category_sel';
    const tagSelId  = prefix + '_tags_sel';
    const tagInpId  = prefix + '_tags';
    const tagHidId  = prefix + (prefix === 'np' ? '_tags_custom' : '_tags_c');

    const catSel = document.getElementById(catSelId);
    const tagSel = document.getElementById(tagSelId);
    if (!catSel || !tagSel) return;

    const selectedCat = catSel.value;
    if (!selectedCat || selectedCat === '__custom__') {
        // é¡åˆ¥æ˜¯è‡ªè¨‚ç¾©æˆ–ç©ºç™½ â†’ è§£é–æ¨™ç±¤
        tagSel.disabled = false;
        return;
    }

    // æ‰¾å‡ºæ­¤é¡åˆ¥å°æ‡‰çš„æ¨™ç±¤ï¼ˆå¾ç¾æœ‰å•†å“å–ç¬¬ä¸€å€‹ç¬¦åˆçš„ï¼‰
    const match = allProducts.find(p => p.category === selectedCat && p.tags);
    if (match) {
        const matchedTag = match.tags.split(',')[0].trim();
        // è¨­å®š select é¸åˆ°å°æ‡‰æ¨™ç±¤
        const opt = [...tagSel.options].find(o => o.value === matchedTag);
        if (opt) {
            tagSel.value = matchedTag;
            // éš±è—è‡ªè¨‚è¼¸å…¥æ¡†
            const tagInp = document.getElementById(tagInpId);
            if (tagInp) tagInp.style.display = 'none';
            const tagHid = document.getElementById(tagHidId);
            if (tagHid) tagHid.value = matchedTag;
        }
        // é–å®šä¸çµ¦æ”¹
        tagSel.disabled = true;
    } else {
        tagSel.disabled = false;
    }
}

function getComboValue(selId, inputId) {
    const sel = document.getElementById(selId);
    if (sel.value === '__custom__') {
        return document.getElementById(inputId).value.trim();
    }
    return sel.value;
}

async function genProductId() {
    if (allProducts.length === 0) {
        try {
            const prodData = await sheetsRead('å•†å“åˆ—è¡¨');
            allProducts = (prodData.values || []).slice(1)
                .filter(r => r[0])
                .map(r => ({ id: String(r[0]), name: String(r[1] || ''), category: String(r[4]||''), tags: String(r[5]||''), customBlock: String(r[6]||'') }));
        } catch(e) { }
    }
    const existing = allProducts.map(p => p.id).filter(id => /^P\d+$/.test(id))
        .map(id => parseInt(id.replace('P','')));
    const nextNum = existing.length > 0 ? Math.max(...existing) + 1 : 1;
    document.getElementById('np_id').value = 'P' + String(nextNum).padStart(3, '0');
}

async function saveNewProduct() {
    const id   = document.getElementById('np_id').value.trim();
    const name = document.getElementById('np_name').value.trim();
    if (!id)   { showToast('è«‹å¡«å…¥å•†å“ç·¨è™Ÿ', 'error'); return; }
    if (!name) { showToast('è«‹å¡«å…¥å•†å“åç¨±', 'error'); return; }

    // ç¢ºèªè‡³å°‘å‹¾é¸ä¸€å€‹è¦æ ¼
    const specNames = ['å–®åŒ…','æ¢','å°'];
    const checkedSpecs = specNames.filter(s => document.getElementById('spec_check_' + s).checked);
    if (checkedSpecs.length === 0) { showToast('è«‹è‡³å°‘é¸ä¸€å€‹è¦æ ¼', 'error'); return; }

    // ç¢ºèªå·²å‹¾é¸è¦æ ¼éƒ½æœ‰å¡«åŸåƒ¹
    for (const s of checkedSpecs) {
        const price = document.getElementById('spec_price_' + s).value.trim();
        if (!price) { showToast(`è«‹å¡«å…¥ã€Œ${s}ã€çš„åŸåƒ¹`, 'error'); return; }
    }

    // å•†å“åˆ—è¡¨è³‡æ–™
    const productRow = {
        id,
        name,
        image:       document.getElementById('np_image').value.trim(),
        isFeatured:  document.getElementById('np_featured').checked ? 'æ˜¯' : '',
        category:    getComboValue('np_category_sel','np_category'),
        tags:        getComboValue('np_tags_sel','np_tags'),
        customBlock: getComboValue('np_block_sel','np_block')
    };

    // è¦æ ¼åˆ—è¡¨è³‡æ–™ï¼ˆæ¯å€‹å‹¾é¸çš„è¦æ ¼å„ä¸€è¡Œï¼‰
    // æ¢çš„åº«å­˜è‡ªå‹•æ²¿ç”¨å–®åŒ…åº«å­˜
    const baoStock = parseInt(document.getElementById('spec_stock_å–®åŒ…')?.value) || 0;
    const specRows = checkedSpecs.map(s => {
        const price    = parseInt(document.getElementById('spec_price_' + s).value) || 0;
        const sale     = parseInt(document.getElementById('spec_sale_'  + s).value) || 0;
        const stock    = s === 'æ¢' ? baoStock : (parseInt(document.getElementById('spec_stock_' + s).value) || 0);
        const multiplier = s === 'æ¢' ? 10 : 1;
        return { specName: s, price, salePrice: sale, stock, multiplier };
    });

    const btn = document.getElementById('addProductSaveBtn');
    btn.disabled = true;
    btn.textContent = 'æ–°å¢ä¸­...';

    try {
        await scriptPost({
            action:     'adminAddProduct',
            adminLineId: adminMember.lineId,
            product:    productRow,
            specs:      specRows
        });
        showToast(`âœ… å•†å“ã€Œ${name}ã€å·²æ–°å¢ï¼`);
        closeAddProductModal();
        switchTab('stock');  // åˆ‡æ›åˆ°åº«å­˜é ä¸¦é‡æ–°è¼‰å…¥
        syncCategoryTags(productRow.tags);  // åŒæ­¥æ–°åˆ†é¡æ¨™ç±¤
    } catch(e) {
        showToast('âŒ æ–°å¢å¤±æ•—ï¼š' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ æ–°å¢å•†å“';
    }
}


// ==========================================
// ğŸ·ï¸ åŒæ­¥å¤§åˆ†é¡æ¨™ç±¤åˆ°åˆ†é¡è¨­å®š
// ==========================================
async function syncCategoryTags(tagsStr) {
    if (!tagsStr) return;
    const inputTags = tagsStr.split(',').map(t => t.trim()).filter(Boolean);
    if (inputTags.length === 0) return;

    try {
        const data = await sheetsRead(CATEGORY_SHEET);
        const rows = (data.values || []).slice(1).filter(r => r[0]);
        const existingNames = rows.map(r => String(r[0] || '').trim());
        const maxOrder = rows.reduce((max, r) => Math.max(max, parseInt(r[1]) || 0), 0);
        const toAdd = inputTags.filter(t => !existingNames.includes(t));
        if (toAdd.length === 0) return;

        await scriptPost({
            action:      'adminAddCategories',
            adminLineId: adminMember.lineId,
            categories:  toAdd.map((name, i) => ({
                name,
                order:   maxOrder + i + 1,
                enabled: 'TRUE'
            }))
        });
        showToast(`âœ… å·²æ–°å¢åˆ†é¡æ¨™ç±¤ï¼š${toAdd.join('ã€')}`);
    } catch(e) {
        console.warn('åˆ†é¡åŒæ­¥å¤±æ•—ï¼š', e.message);
    }
}

// ==========================================
// å·¥å…·
// ==========================================
function escHtml(str) {
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// é—œé–‰ modal é»èƒŒæ™¯
document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
});

// ==========================================
// ğŸ”§ ç¶­è­·æ¨¡å¼
// ==========================================
let isMaintenance = false;

async function loadMaintenanceStatus() {
    try {
        const data = await sheetsRead(SYSTEM_SHEET);
        const rows = (data.values || []);
        const maintRow = rows.find(r => String(r[0]).trim() === 'ç¶­è­·æ¨¡å¼');
        isMaintenance = maintRow ? String(maintRow[1]).trim().toUpperCase() === 'TRUE' : false;
        updateMaintenanceBtn();
        // åŒæ™‚è¼‰å…¥ç›£æ§æ¨¡å¼ç‹€æ…‹
        const monitorRow = rows.find(r => String(r[0]).trim() === 'ç›£æ§æ¨¡å¼');
        isMonitorMode = monitorRow ? String(monitorRow[1]).trim().toUpperCase() === 'TRUE' : false;
        updateMonitorBtn();
    } catch(e) {
        console.warn('è®€å–ç³»çµ±è¨­å®šå¤±æ•—ï¼š', e.message);
    }
}

function updateMaintenanceBtn() {
    const btn = document.getElementById('maintenanceBtn');
    if (!btn) return;
    if (isMaintenance) {
        btn.textContent = 'ğŸ”´ ç¶­è­·ä¸­ï¼ˆé»æ“Šé—œé–‰ï¼‰';
        btn.style.background  = 'rgba(255,68,68,0.15)';
        btn.style.borderColor = '#ff4444';
        btn.style.color       = '#ff4444';
    } else {
        btn.textContent = 'ğŸ”§ ç¶­è­·æ¨¡å¼';
        btn.style.background  = 'rgba(255,255,255,0.05)';
        btn.style.borderColor = '#555';
        btn.style.color       = '#888';
    }
}

async function toggleMaintenance() {
    const newVal = !isMaintenance;
    const label  = newVal ? 'é–‹å•Ÿç¶­è­·æ¨¡å¼' : 'é—œé–‰ç¶­è­·æ¨¡å¼';
    if (!confirm(`ç¢ºå®šè¦${label}å—ï¼Ÿ`)) return;

    const btn = document.getElementById('maintenanceBtn');
    if (btn) { btn.disabled = true; btn.textContent = 'è™•ç†ä¸­...'; }

    try {
        // å…ˆè®€å–ç›®å‰ sheetï¼Œæ‰¾åˆ°ã€Œç¶­è­·æ¨¡å¼ã€åœ¨ç¬¬å¹¾åˆ—
        const data = await sheetsRead(SYSTEM_SHEET);
        const rows = data.values || [];
        // çµ±ä¸€ç”¨ setSystemSettingï¼Œè®“ Apps Script è² è²¬ upsertï¼ˆæ‰¾åˆ°å°±æ›´æ–°ï¼Œæ‰¾ä¸åˆ°å°±æ–°å¢ï¼‰
        await scriptPost({
            action:      'setSystemSetting',
            adminLineId: adminMember.lineId,
            key:         'ç¶­è­·æ¨¡å¼',
            value:       newVal ? 'TRUE' : 'FALSE'
        });

        isMaintenance = newVal;
        updateMaintenanceBtn();
        showToast(newVal ? 'ğŸ”´ ç¶­è­·æ¨¡å¼å·²é–‹å•Ÿï¼Œä¸»ç¶²é é¡¯ç¤ºç¶­è­·ä¸­' : 'âœ… ç¶­è­·æ¨¡å¼å·²é—œé–‰ï¼Œä¸»ç¶²é æ¢å¾©æ­£å¸¸');
    } catch(e) {
        showToast('âŒ æ“ä½œå¤±æ•—ï¼š' + e.message, 'error');
        updateMaintenanceBtn(); // é‚„åŸæŒ‰éˆ•ç‹€æ…‹
    } finally {
        if (btn) btn.disabled = false;
    }
}

// ==========================================
// ğŸ‘ï¸ ç›£æ§æ¨¡å¼ï¼ˆæ§åˆ¶ ecommerce.html çš„ pollMaintenanceStatusï¼‰
// ==========================================
let isMonitorMode = false;

async function loadMonitorStatus() {
    try {
        const data = await sheetsRead(SYSTEM_SHEET);
        const rows = data.values || [];
        const row = rows.find(r => String(r[0]).trim() === 'ç›£æ§æ¨¡å¼');
        isMonitorMode = row ? String(row[1]).trim().toUpperCase() === 'TRUE' : false;
        updateMonitorBtn();
    } catch(e) {
        console.warn('è®€å–ç›£æ§æ¨¡å¼å¤±æ•—ï¼š', e.message);
    }
}

function updateMonitorBtn() {
    const btn = document.getElementById('monitorBtn');
    if (!btn) return;
    if (isMonitorMode) {
        btn.textContent = 'ğŸŸ¢ ç›£æ§ä¸­ï¼ˆé»æ“Šé—œé–‰ï¼‰';
        btn.style.background  = 'rgba(0,255,0,0.1)';
        btn.style.borderColor = '#00FF00';
        btn.style.color       = '#00FF00';
    } else {
        btn.textContent = 'ğŸ‘ï¸ ç›£æ§æ¨¡å¼';
        btn.style.background  = 'rgba(255,255,255,0.05)';
        btn.style.borderColor = '#555';
        btn.style.color       = '#888';
    }
}

async function toggleMonitor() {
    const newVal = !isMonitorMode;
    const label = newVal ? 'é–‹å•Ÿç›£æ§æ¨¡å¼' : 'é—œé–‰ç›£æ§æ¨¡å¼';
    if (!confirm(`ç¢ºå®šè¦${label}å—ï¼Ÿ

é–‹å•Ÿå¾Œï¼Œå‰å°æ¯ 30 ç§’æœƒæª¢æŸ¥ç¶­è­·ç‹€æ…‹ï¼ˆæ¶ˆè€— API ç”¨é‡ï¼‰ã€‚
é—œé–‰å¾Œå‰å°åœæ­¢è¼ªè©¢ï¼Œå»ºè­°å¹³æ™‚é—œé–‰ã€éœ€è¦å³æ™‚ç›£æ§æ™‚å†é–‹ã€‚`)) return;

    const btn = document.getElementById('monitorBtn');
    if (btn) { btn.disabled = true; btn.textContent = 'è™•ç†ä¸­...'; }

    try {
        await scriptPost({
            action:      'setSystemSetting',
            adminLineId: adminMember.lineId,
            key:         'ç›£æ§æ¨¡å¼',
            value:       newVal ? 'TRUE' : 'FALSE'
        });
        isMonitorMode = newVal;
        updateMonitorBtn();
        showToast(newVal ? 'ğŸŸ¢ ç›£æ§æ¨¡å¼å·²é–‹å•Ÿï¼Œå‰å°é–‹å§‹è¼ªè©¢ç¶­è­·ç‹€æ…‹' : 'âšª ç›£æ§æ¨¡å¼å·²é—œé–‰ï¼Œå‰å°åœæ­¢è¼ªè©¢');
    } catch(e) {
        showToast('âŒ æ“ä½œå¤±æ•—ï¼š' + e.message, 'error');
        updateMonitorBtn();
    } finally {
        if (btn) btn.disabled = false;
    }
}

// ==========================================
// ğŸï¸ æ¸¬é€Ÿï¼šæ¸¬è©¦ sheets-init å›æ‡‰æ™‚é–“
// ==========================================
async function testInitSpeed() {
    const btn = document.getElementById('speedTestBtn');
    if (!btn) return;
    btn.disabled = true;
    btn.textContent = 'â³ æ¸¬é€Ÿä¸­...';

    try {
        const t0 = performance.now();
        const res = await fetch('/api/sheets-init?t=' + Date.now()); // åŠ æ™‚é–“æˆ³é¿å…ç€è¦½å™¨å¿«å–
        await res.json();
        const ms = Math.round(performance.now() - t0);
        const cacheHit = res.headers.get('X-Cache') === 'HIT';

        let emoji = ms < 300 ? 'ğŸš€' : ms < 1000 ? 'âš¡' : ms < 3000 ? 'ğŸ¢' : 'ğŸŒ';
        let label = cacheHit ? 'å¿«å–å‘½ä¸­' : 'ç›´æ¥æŠ“å–';
        showToast(`${emoji} sheets-initï¼š${ms} msï¼ˆ${label}ï¼‰`, ms < 1000 ? 'success' : '');
    } catch(e) {
        showToast('âŒ æ¸¬é€Ÿå¤±æ•—ï¼š' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸï¸ æ¸¬é€Ÿ';
    }
}

// ==========================================
// âš¡ åˆ·æ–° KV å¿«å–
// ==========================================
async function refreshCache() {
    const btn = document.getElementById('cacheRefreshBtn');
    if (!btn) return;
    btn.disabled = true;
    btn.textContent = 'â³ åˆ·æ–°ä¸­...';
    btn.style.borderColor = '#555';
    btn.style.color = '#888';

    try {
        const res = await fetch('/api/sheets-refresh', { method: 'POST' });
        const json = await res.json();
        if (json.ok) {
            // âœ… åŒæ™‚æ¸…é™¤å‰ç«¯ localStorage å¿«å–ï¼Œç¢ºä¿ç®¡ç†å“¡è‡ªå·±ä¹Ÿç«‹å³çœ‹åˆ°æœ€æ–°è³‡æ–™
            try { localStorage.removeItem('rexshop_init_cache'); } catch(e) {}
            showToast('âš¡ å¿«å–å·²æ¸…é™¤ï¼æ‰€æœ‰ä½¿ç”¨è€…ä¸‹æ¬¡é–‹å•Ÿå°‡æŠ“å–æœ€æ–°è³‡æ–™', 'success');
        } else {
            showToast('âŒ åˆ·æ–°å¤±æ•—ï¼š' + (json.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
        }
    } catch(e) {
        showToast('âŒ åˆ·æ–°å¤±æ•—ï¼š' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'âš¡ åˆ·æ–°å¿«å–';
        btn.style.borderColor = '#00bfff';
        btn.style.color = '#00bfff';
    }
}

// å•Ÿå‹•
init();
</script>
</body>
</html>
